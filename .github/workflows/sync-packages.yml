name: Sync Tizen Community Packages

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

permissions:
  contents: write

env:
  TIZEN_STUDIO_VER: 4
  CERT_NAME: CommunityPack
  CERT_PASSWORD: 1234
  NODE_OPTIONS: --openssl-legacy-provider

jobs:
  prepare:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # -----------------------------------------
      # ðŸ§© CACHE: Tizen SDK (massive time saver)
      # -----------------------------------------
      - name: Restore Tizen SDK cache
        id: tizen-sdk-cache
        uses: actions/cache@v4
        with:
          path: tizen-studio
          key: tizen-sdk-4.0

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            wget zip git jq nodejs npm expect curl unzip build-essential \
            libtool help2man ragel nasm protobuf-compiler meson

      - name: Download and install Tizen Studio 4.0
        if: steps.tizen-sdk-cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p tizen-studio
          curl -L -o tizen-installer "https://github.com/PatrickSt1991/tizen-community-packages/releases/download/tizen-deps-5.5/web-cli_Tizen_Studio_4.0_ubuntu-64.bin"
          chmod +x tizen-installer
          ./tizen-installer --accept-license "${GITHUB_WORKSPACE}/tizen-studio"
          rm ./tizen-installer
          chmod -R +x tizen-studio/tools/ide/bin

      - name: Install Tizen 4.0 Rootstrap and Toolchain
        if: steps.tizen-sdk-cache.outputs.cache-hit != 'true'
        run: |
          set -e
          WORKDIR="${GITHUB_WORKSPACE}/tizen-studio"

          # Toolchain (REPLACEMENT: clean official GCC 4.9)
          echo "ðŸ§¹ Removing old/bad toolchain..."
          rm -rf "${WORKDIR}/tools/arm-linux-gnueabi-gcc-4.9" || true
          
          TOOLCHAIN_URL="https://download.tizen.org/sdk/tizenstudio/official/binary/cross-arm-gcc-4.9_1.1.0_ubuntu-64.zip"
          
          echo "â¬‡ï¸ Downloading clean ARM gcc-4.9 toolchain..."
          curl -L -o "${WORKDIR}/toolchain.zip" "$TOOLCHAIN_URL"
          
          echo "ðŸ“¦ Extracting..."
          unzip -q "${WORKDIR}/toolchain.zip" "data/tools/*" -d "${WORKDIR}/tools-tmp"
          
          echo "ðŸ”§ Installing toolchain..."
          mv "${WORKDIR}/tools-tmp/data/tools/arm-linux-gnueabi-gcc-4.9" \
             "${WORKDIR}/tools/arm-linux-gnueabi-gcc-4.9"
          
          echo "ðŸ§¼ Cleanup..."
          rm -rf "${WORKDIR}/tools-tmp" "${WORKDIR}/toolchain.zip"
          
          echo "âœ” Toolchain installed:"
          ls -l "${WORKDIR}/tools/arm-linux-gnueabi-gcc-4.9/bin"


      - name: Save SDK to cache
        if: steps.tizen-sdk-cache.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: tizen-studio
          key: tizen-sdk-4.0

      - name: Create signing certificate
        run: |
          mkdir -p tizen-studio-data/keystore/author tizen-studio-data/profile
          ./tizen-studio/tools/ide/bin/tizen certificate \
            -a "$CERT_NAME" -p "$CERT_PASSWORD" \
            -c NL -s Community -ct World \
            -o "$CERT_NAME" -n "$CERT_NAME" \
            -e community@example.org -f "$CERT_NAME"

          ./tizen-studio/tools/ide/bin/tizen security-profiles add \
            -n "$CERT_NAME" \
            -a "./tizen-studio-data/keystore/author/${CERT_NAME}.p12" \
            -p "$CERT_PASSWORD"

          ./tizen-studio/tools/ide/bin/tizen cli-config \
            "profiles.path=./tizen-studio-data/profile/profiles.xml"

      - name: Create expect script
        run: |
          printf '%s\n' \
            '#!/usr/bin/expect -f' \
            'set timeout 300' \
            'set build_dir [lindex $argv 0]' \
            'spawn $env(TIZEN_PATH)/tools/ide/bin/tizen package -t wgt -s CommunityPack -- $build_dir' \
            'expect {' \
            '  "Author password:" { send "$env(CERT_PASSWORD)\r"; exp_continue }' \
            '  "Distributor1 password:" { send "$env(CERT_PASSWORD)\r"; exp_continue }' \
            '  eof' \
            '}' \
            > package.exp
          chmod +x package.exp

      - uses: actions/upload-artifact@v4
        with:
          name: tizen-studio-artifact
          path: tizen-studio/
          retention-days: 1

      - uses: actions/upload-artifact@v4
        with:
          name: package-exp-artifact
          path: package.exp
          retention-days: 1

  generate-matrix-build:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
      - id: set-matrix
        run: |
          matrix=$(jq -c \
            '{include: [to_entries[] | {
               repo: .key,
               branch: .value.branch,
               build_script: (.value.build_script // ""),
               build_args: (.value.build_args // "")
            }]}' repos-build.json)
          echo "matrix=$matrix" >> "$GITHUB_OUTPUT"

  tizen-build:
    runs-on: ubuntu-latest
    needs: [prepare, generate-matrix-build]

    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.generate-matrix-build.outputs.matrix).include }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: tizen-studio-artifact
          path: tizen-studio

      - uses: actions/download-artifact@v4
        with:
          name: package-exp-artifact
          path: .

      - name: Install VLC prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            help2man ragel nasm yasm meson \
            protobuf-compiler build-essential pkg-config \
            automake autoconf libtool libtool-bin gettext

      # ----------------------------------------------
      # ðŸ§© CACHE: VLC contrib & extras/tools
      # ----------------------------------------------
      - name: Restore VLC contrib cache
        id: vlc-contrib-cache
        uses: actions/cache@v4
        with:
          path: |
            build/vlc-tizen/vlc/contrib/tarballs
            build/vlc-tizen/vlc/extras/tools
          key: vlc-contrib-cache-4e0fa1b

      - name: Clone and build project
        shell: bash
        env:
          TIZEN_SDK: ${{ github.workspace }}/tizen-studio
          TIZEN_PATH: ${{ github.workspace }}/tizen-studio
        run: |
          set -e
          mkdir -p "$GITHUB_WORKSPACE/wgt_files" build
          cd build

          git clone --depth 1 --branch "${{ matrix.branch }}" \
            "https://github.com/${{ matrix.repo }}.git"

          cd "$(basename "${{ matrix.repo }}")"
          repo_name="$(basename "${{ matrix.repo }}")"

          if [[ "$repo_name" != "vlc-tizen" ]]; then
            echo "Building standard web project..."
            "$TIZEN_PATH/tools/ide/bin/tizen" build-web || true
            "$TIZEN_PATH/tools/ide/bin/tizen" package \
              -t wgt -o "$GITHUB_WORKSPACE/wgt_files/" || true
            exit 0
          fi

          # ------------------------------------------------------
          #               VLC-TIZEN BUILD PATH
          # ------------------------------------------------------
          echo "Building VLC-Tizen..."

          echo "Using Tizen SDK..."
          SYSROOT="$TIZEN_SDK/platforms/tizen-4.0/mobile/rootstraps/mobile-4.0-device.core"
          echo "ðŸ”§ Using sysroot: $SYSROOT"

          echo "ðŸ”§ Forcing correct Tizen SDK version..."
          printf '#!/bin/sh\necho 4.0\n' > "$TIZEN_SDK/sdk.version"
          chmod +x "$TIZEN_SDK/sdk.version"
          
          export TIZEN_SDK_VERSION=4.0
          export TIZEN_SDK_ROOT="$TIZEN_SDK"
          
          export PATH="$TIZEN_SDK/tools/arm-linux-gnueabi-gcc-4.9/bin:$PATH"
          
          # Clone VLC source
          if [[ ! -d vlc ]]; then
            git clone https://code.videolan.org/videolan/vlc.git vlc
            pushd vlc
            git checkout 4e0fa1b
            popd
          fi

          # --------------------------------------------------
          # Pre-seed contrib tarballs (will use cached files)
          # --------------------------------------------------
          CONTRIB_DIR="vlc/contrib/tarballs"
          mkdir -p "$CONTRIB_DIR"

          download() {
            [[ -f "$CONTRIB_DIR/$1" ]] && { echo "âœ” Cached $1"; return; }
            echo "â¬‡ï¸ Downloading $1"
            curl -L --fail --retry 4 --retry-delay 2 "$2" -o "$CONTRIB_DIR/$1"
          }

          declare -A PKG_URLS=(
            ["a52dec-0.7.4.tar.gz"]="https://downloads.videolan.org/pub/contrib/a52dec-0.7.4.tar.gz"
            ["libass-0.13.0.tar.gz"]="https://downloads.videolan.org/testing/contrib/ass/libass-0.13.0.tar.gz"
            ["libdvbpsi-1.3.0.tar.bz2"]="https://downloads.videolan.org/pub/videolan/libdvbpsi/1.3.0/libdvbpsi-1.3.0.tar.bz2"
            ["libdvdcss-1.3.99.tar.bz2"]="https://downloads.videolan.org/pub/videolan/libdvdcss/1.3.99/libdvdcss-1.3.99.tar.bz2"
            ["libdvdnav-5.0.3.tar.bz2"]="https://downloads.videolan.org/pub/videolan/libdvdnav/5.0.3/libdvdnav-5.0.3.tar.bz2"
            ["libdvdread-5.0.3.tar.bz2"]="https://downloads.videolan.org/pub/videolan/libdvdread/5.0.3/libdvdread-5.0.3.tar.bz2"
            ["libebml-1.3.3.tar.bz2"]="https://downloads.videolan.org/pub/pub/contrib/ebml/libebml-1.3.3.tar.bz2"
            ["libmatroska-1.4.4.tar.bz2"]="https://downloads.videolan.org/pub/pub/contrib/matroska/libmatroska-1.4.4.tar.bz2"
            ["libmad-0.15.1b.tar.gz"]="https://downloads.videolan.org/pub/contrib/libmad-0.15.1b.tar.gz"
            ["libmpeg2-0.5.1.tar.gz"]="https://download.videolan.org/contrib/libmpeg2/libmpeg2-0.5.1.tar.gz"
            ["flac-1.3.1.tar.xz"]="https://download.videolan.org/contrib/flac/flac-1.3.1.tar.xz"
            ["freetype-2.6.1.tar.gz"]="https://download.videolan.org/contrib/freetype2/freetype-2.6.1.tar.gz"
            ["fribidi-0.19.7.tar.bz2"]="https://download.videolan.org/contrib/fribidi/fribidi-0.19.7.tar.bz2"
            ["harfbuzz-1.0.6.tar.bz2"]="https://download.videolan.org/pub/contrib/harfbuzz/harfbuzz-1.0.6.tar.bz2"
            ["gnutls-3.2.21.tar.xz"]="https://downloads.videolan.org/pub/pub/contrib/gnutls/gnutls-3.2.21.tar.xz"
            ["libtasn1-3.7.tar.gz"]="https://download.videolan.org/pub/pub/contrib/libtasn1/libtasn1-3.7.tar.gz"
            ["libgcrypt-1.6.2.tar.bz2"]="https://download.videolan.org/contrib/gcrypt/libgcrypt-1.6.2.tar.bz2"
            ["libgpg-error-1.18.tar.bz2"]="https://download.videolan.org/pub/contrib/gpg-error/libgpg-error-1.18.tar.bz2"
            ["gmp-6.0.0.tar.bz2"]="https://download.videolan.org/contrib/gmp/gmp-6.0.0.tar.bz2"
            ["libiconv-1.14.tar.gz"]="https://download.videolan.org/contrib/iconv/libiconv-1.14.tar.gz"
            ["libxml2-2.9.2.tar.gz"]="https://download.videolan.org/pub/contrib/libxml2/libxml2-2.9.2.tar.gz"
            ["jpegsrc.v9a.tar.gz"]="https://download.videolan.org/contrib/jpeg/jpegsrc.v9a.tar.gz"
            ["live.2015.06.24.tar.gz"]="https://downloads.videolan.org/pub/contrib/live555/live.2015.06.24.tar.gz"
            ["ffmpeg-HEAD.tar.xz"]="https://ffmpeg.org/releases/ffmpeg-4.4.tar.xz"
            ["libmodplug-0.8.8.5.tar.gz"]="https://download.videolan.org/contrib/modplug/libmodplug-0.8.8.5.tar.gz"
            ["nettle-2.7.1.tar.gz"]="https://download.videolan.org/contrib/nettle/nettle-2.7.1.tar.gz"
            ["openjpeg-1.5.0.tar.gz"]="https://download.videolan.org/contrib/openjpeg/openjpeg-1.5.0.tar.gz"
            ["libcddb-1.3.2.tar.bz2"]="https://download.videolan.org/testing/contrib/cddb/libcddb-1.3.2.tar.bz2"
            ["chromaprint-1.0.tar.gz"]="https://download.videolan.org/contrib/chromaprint-1.0.tar.gz"
            ["faad2-2.7.tar.gz"]="https://download.videolan.org/contrib/faad2/faad2-2.7.tar.gz"
            ["libffi-3.0.13.tar.gz"]="https://download.videolan.org/testing/contrib/ffi/libffi-3.0.13.tar.gz"
            ["fluidsynth-1.1.6.tar.bz2"]="https://download.videolan.org/contrib/fluid/fluidsynth-1.1.6.tar.bz2"
            ["glew-1.7.0.tar.gz"]="https://download.videolan.org/testing/contrib/glew/glew-1.7.0.tar.gz"
            ["glib-2.38.tar.xz"]="https://download.gnome.org/sources/glib/2.38/glib-2.38.0.tar.xz"
            ["game-music-emu-0.6.0.tar.bz2"]="https://download.videolan.org/pub/contrib/gme/game-music-emu-0.6.0.tar.bz2"
            ["growl-1.2.2.tar.bz2"]="https://download.videolan.org/testing/contrib/growl/growl-1.2.2.tar.bz2"
            ["libkate-0.4.1.tar.gz"]="https://download.videolan.org/pub/pub/contrib/kate/libkate-0.4.1.tar.gz"
            ["lame-3.99.5.tar.gz"]="https://download.videolan.org/pub/contrib/lame/lame-3.99.5.tar.gz"
            ["mpg123-1.21.0.tar.bz2"]="https://download.videolan.org/contrib/mpg123/mpg123-1.21.0.tar.bz2"
            ["libpng-1.6.19.tar.xz"]="https://download.videolan.org/pub/contrib/png/libpng-1.6.19.tar.xz"
            ["projectM-2.0.1-Source.tar.gz"]="https://download.videolan.org/contrib/projectM/projectM-2.0.1-Source.tar.gz"
            ["pthreads-w32-2-9-1-release.tar.gz"]="https://download.videolan.org/pub/contrib/pthreads/pthreads-w32-2-9-1-release.tar.gz"
            ["sidplay-libs-2.1.1.tar.gz"]="https://download.videolan.org/pub/contrib/sidplay2/sidplay-libs-2.1.1.tar.gz"
            ["soxr-0.1.2-Source.tar.xz"]="https://download.videolan.org/pub/contrib/soxr-0.1.2-Source.tar.xz"
            ["tiff-4.0.3.tar.gz"]="https://download.videolan.org/contrib/tiff/tiff-4.0.3.tar.gz"
            ["libtiger-0.3.1.tar.gz"]="https://download.videolan.org/pub/contrib/tiger/libtiger-0.3.1.tar.gz"
            ["twolame-0.3.13.tar.gz"]="https://download.videolan.org/contrib/twolame/twolame-0.3.13.tar.gz"
            ["libupnp-1.6.19.tar.bz2"]="https://download.videolan.org/contrib/upnp/libupnp-1.6.19.tar.bz2"
            ["LibVNCServer-0.9.9.tar.gz"]="https://download.videolan.org/testing/contrib/vncclient/LibVNCServer-0.9.9.tar.gz"
            ["zlib-1.2.8.tar.gz"]="https://download.videolan.org/pub/contrib/zlib/zlib-1.2.8.tar.gz"
            ["zvbi-0.2.35.tar.bz2"]="https://download.videolan.org/contrib/zvbi/zvbi-0.2.35.tar.bz2"
          )

          for F in "${!PKG_URLS[@]}"; do
            download "$F" "${PKG_URLS[$F]}"
          done

          # ---------------------------------------------
          # Build extras/tools unless cached
          # ---------------------------------------------
          if [[ "${{ steps.vlc-contrib-cache.outputs.cache-hit }}" != "true" ]]; then
            pushd vlc/extras/tools
            ./bootstrap
            make -j"$(nproc)"
            popd
          else
            echo "âœ” Using cached extras/tools"
          fi

          # -----------------------------------------------------
          # Build VLC for Tizen
          # -----------------------------------------------------
          echo "ðŸ§¹ Removing previous contrib build (avoids poisoned include paths)..."
          rm -rf vlc/contrib/contrib-tizen-arm-linux-gnueabi

          echo "ðŸ”§ Cleaning entire build environment (fix poisoning)..."
          
          # Remove everything VLC/Contrib could have cached
          unset PKG_CONFIG_PATH
          unset PKG_CONFIG_LIBDIR
          unset PKG_CONFIG_SYSROOT_DIR
          
          unset CPPFLAGS
          unset CFLAGS
          unset CXXFLAGS
          unset LDFLAGS
          
          unset EXTRA_CFLAGS
          unset EXTRA_CXXFLAGS
          unset EXTRA_LDFLAGS
          
          # Remove host includes that GCC might auto-insert
          unset CPATH
          unset C_INCLUDE_PATH
          unset CPLUS_INCLUDE_PATH
          unset LIBRARY_PATH
          
          export CC="$TIZEN_SDK/tools/arm-linux-gnueabi-gcc-4.9/bin/arm-linux-gnueabi-gcc"
          export CXX="$TIZEN_SDK/tools/arm-linux-gnueabi-gcc-4.9/bin/arm-linux-gnueabi-g++"

          # Clean environment so contrib sets flags correctly
          export PKG_CONFIG_SYSROOT_DIR="$SYSROOT"
          export PKG_CONFIG_PATH="$SYSROOT/usr/lib/pkgconfig:$SYSROOT/usr/share/pkgconfig"
          export PKG_CONFIG_LIBDIR="$PKG_CONFIG_PATH"

          
          echo "ðŸ”§ Fixing lost permissions in the Tizen GCC toolchain..."
          chmod -R +x "$TIZEN_SDK/tools/arm-linux-gnueabi-gcc-4.9"
                    
          echo "ðŸš§ Starting VLC compilation..."
          
          # Force contrib to expose real failing contrib
          export VERBOSE=1
          export V=1
          export MAKEFLAGS="-j1"
          
          # Force contrib NOT to pick up forbidden host include paths
          export CCACHE_DISABLE=1
          unset CCACHE_DIR
          unset CPATH
          unset C_INCLUDE_PATH
          unset CPLUS_INCLUDE_PATH
          unset LIBRARY_PATH
          
          # Freeze sysroot so contrib can't wander off into host dirs
          export PKG_CONFIG_SYSROOT_DIR="$SYSROOT"
          export PKG_CONFIG_LIBDIR="$SYSROOT/usr/lib/pkgconfig:$SYSROOT/usr/share/pkgconfig"
          
          # Make sure the Tizen toolchain is the ONLY toolchain
          export PATH="$TIZEN_SDK/tools/arm-linux-gnueabi-gcc-4.9/bin:$PATH"

          echo "Patching contrib bootstrap options..."
          export VLC_CONTRIB_ARGS="--disable-schroedinger --disable-mad --disable-projectm --disable-upnp --disable-swscale"
          
          pushd vlc/contrib
          echo 'append_args() { for a in $VLC_CONTRIB_ARGS; do set -- "$@" "$a"; done; printf "%s\n" "$@"; exit; }' > append.sh
          chmod +x append.sh
          
          sed -i '1i\set -- $(./append.sh "$@")' bootstrap
          popd

          echo "Removing Samsung DIBS hardcoded include paths from contrib..."
          
          # Remove the two poison include lines
          sed -i \
            '/CPPFLAGS += -I\/root\/\.dibs\/srib-dibs-builder-s42-u64\/workspace\/jobs\/3504\/buildRoot\/rs-devel_glibc-2.20\.armv7l\/usr\/include/d' \
            vlc/contrib/src/main.mak
          
          sed -i \
            '/CFLAGS   += -I\/root\/\.dibs\/srib-dibs-builder-s42-u64\/workspace\/jobs\/3504\/buildRoot\/rs-devel_glibc-2.20\.armv7l\/usr\/include/d' \
            vlc/contrib/src/main.mak
          
          echo "âœ” contrib/src/main.mak successfully cleaned"
          
          ./buildall.sh -a armv7l || {
              echo "âŒ buildall.sh FAILED â€” locating REAL failing contrib module..."
          
              ROOT="vlc/contrib/contrib-tizen-arm-linux-gnueabi"
          
              # --------------------------------------------------------------------
              # 1. Detect REAL failing module using stamp logic
              # --------------------------------------------------------------------
              FAILED_MODULE=$(find "$ROOT" -maxdepth 2 -name ".stamp-configure" | \
                  while read f; do
                      MOD=$(dirname "$f")
                      if [[ ! -f "$MOD/.stamp-build" ]]; then
                          echo "$MOD"
                      fi
                  done | head -n 1)
          
              if [[ -z "$FAILED_MODULE" ]]; then
                  echo "âš  Could not find failing module via stamp files â€” using fallback scan."
                  FAILED_MODULE=$(find "$ROOT" -maxdepth 2 -type d \
                                  ! -name ".*" | sort | head -n 1)
              fi
          
              echo "ðŸ”¥ REAL failing module: $FAILED_MODULE"
          
              # --------------------------------------------------------------------
              # 2. Dump config.log if present
              # --------------------------------------------------------------------
              if [[ -f "$FAILED_MODULE/config.log" ]]; then
                  echo ""
                  echo "ðŸ“„ Showing FIRST 200 lines of config.log:"
                  echo "------------------------------------------------------------"
                  sed -n '1,200p' "$FAILED_MODULE/config.log" || true
          
                  echo ""
                  echo "ðŸ“„ Showing LAST 200 lines of config.log:"
                  echo "------------------------------------------------------------"
                  tail -n 200 "$FAILED_MODULE/config.log" || true
              else
                  echo "âš  config.log does NOT exist â€” meaning configure failed before writing it."
              fi
          
              # --------------------------------------------------------------------
              # 3. Re-run make with full debug output
              # --------------------------------------------------------------------
              echo ""
              echo "ðŸ” Re-running make inside $FAILED_MODULE"
              echo "------------------------------------------------------------"
          
              make -C "$FAILED_MODULE" V=1 --debug=b || true
          
              echo "------------------------------------------------------------"
              echo "âŒ Stopping build â€” module above is the ACTUAL failing part."
              exit 1
          }


          echo "Packaging WGT..."
          expect "$GITHUB_WORKSPACE/package.exp" "$(pwd)" || true
          cp -r ./*.wgt "$GITHUB_WORKSPACE/wgt_files/" 2>/dev/null || true

      - uses: softprops/action-gh-release@v2
        with:
          tag_name: "community-${{ github.run_number }}"
          name: "Community Packages ${{ github.run_number }}"
          files: "wgt_files/*.wgt"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-release:
    runs-on: ubuntu-latest
    needs: tizen-build

    steps:
      - uses: actions/download-artifact@v4
        with:
          path: release-wgts

      - name: List files
        run: ls -R release-wgts || true

      - uses: softprops/action-gh-release@v2
        with:
          tag_name: "community-${{ github.run_number }}"
          name: "Community Packages ${{ github.run_number }}"
          files: "release-wgts/**/*.wgt"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
