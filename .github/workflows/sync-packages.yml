name: Sync Tizen Community Packages

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

permissions:
  contents: write

env:
  TIZEN_STUDIO_VER: 4
  CERT_NAME: CommunityPack
  CERT_PASSWORD: 1234
  NODE_OPTIONS: --openssl-legacy-provider

jobs:
  prepare:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # -----------------------------------------
      # ðŸ§© CACHE: Tizen SDK (massive time saver)
      # -----------------------------------------
      - name: Restore Tizen SDK cache
        id: tizen-sdk-cache
        uses: actions/cache@v4
        with:
          path: tizen-studio
          key: tizen-sdk-4.0

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            wget zip git jq nodejs npm expect curl unzip build-essential \
            libtool help2man ragel nasm protobuf-compiler meson

      - name: Download and install Tizen Studio 4.0
        if: steps.tizen-sdk-cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p tizen-studio
          curl -L -o tizen-installer "https://github.com/PatrickSt1991/tizen-community-packages/releases/download/tizen-deps-5.5/web-cli_Tizen_Studio_4.0_ubuntu-64.bin"
          chmod +x tizen-installer
          ./tizen-installer --accept-license "${GITHUB_WORKSPACE}/tizen-studio"
          rm ./tizen-installer
          chmod -R +x tizen-studio/tools/ide/bin

      - name: Install Tizen 4.0 rootstrap (0.0.62)
        if: steps.tizen-sdk-cache.outputs.cache-hit != 'true'
        run: |
          set -e
          cd tizen-studio

          echo "â¬‡ï¸ Downloading MOBILE-4.0 rootstrap 0.0.62..."
          curl -L -o rootstrap.zip \
            "https://download.tizen.org/sdk/tizenstudio/official/binary/mobile-4.0-rs-device.core_0.0.62_ubuntu-64.zip"

          echo "ðŸ“¦ Extracting rootstrap..."
          unzip -o rootstrap.zip

          echo "ðŸ“ Moving rootstrap into final SDK path..."
          mkdir -p platforms/tizen-4.0/mobile/rootstraps/
          rsync -av data/platforms/tizen-4.0/mobile/rootstraps/mobile-4.0-device.core \
            platforms/tizen-4.0/mobile/rootstraps/

          echo "ðŸ§¹ Cleaning..."
          rm -rf data rootstrap.zip

          echo "âœ” Rootstrap installed successfully"

      - name: Install GCC 4.9 Cross Toolchain
        if: steps.tizen-sdk-cache.outputs.cache-hit != 'true'
        run: |
          set -e
          cd tizen-studio/tools

          echo "â¬‡ï¸ Downloading GCC 4.9 toolchain components..."
          curl -L -O https://download.tizen.org/sdk/tizenstudio/official/binary/cross-arm-gcc-4.9_1.1.0_ubuntu-64.zip
          curl -L -O https://download.tizen.org/sdk/tizenstudio/official/binary/cross-arm-gdb-7.8_1.1.2_ubuntu-64.zip
          curl -L -O https://download.tizen.org/sdk/tizenstudio/official/binary/NativeToolchain-Gcc-4.9_3.0.6_ubuntu-64.zip

          echo "ðŸ“¦ Extracting cross toolchains..."
          unzip -o cross-arm-gcc-4.9_1.1.0_ubuntu-64.zip
          unzip -o cross-arm-gdb-7.8_1.1.2_ubuntu-64.zip
          unzip -o NativeToolchain-Gcc-4.9_3.0.6_ubuntu-64.zip
          
          echo "ðŸ” Applying execute permissions..."
          find . -type d -name "*gcc-4.9*" -exec chmod -R +x {} \;
          find . -type d -name "*gdb-7.8*" -exec chmod -R +x {} \;
          find . -type f -name "arm-linux-gnueabi-*" -exec chmod +x {} \;
          find . -type f -path "*/libexec/gcc/*/cc1" -exec chmod +x {} \;
          find . -type f -path "*/libexec/gcc/*/cc1plus" -exec chmod +x {} \;

          echo "ðŸ§¹ Cleaning..."
          rm cross-arm-gcc-4.9_1.1.0_ubuntu-64.zip
          rm cross-arm-gdb-7.8_1.1.2_ubuntu-64.zip
          rm NativeToolchain-Gcc-4.9_3.0.6_ubuntu-64.zip

          echo "âœ” GCC 4.9 installed"


      - name: Save SDK to cache
        if: steps.tizen-sdk-cache.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: tizen-studio
          key: tizen-sdk-4.0

      - name: Create signing certificate
        run: |
          mkdir -p tizen-studio-data/keystore/author tizen-studio-data/profile
          ./tizen-studio/tools/ide/bin/tizen certificate \
            -a "$CERT_NAME" -p "$CERT_PASSWORD" \
            -c NL -s Community -ct World \
            -o "$CERT_NAME" -n "$CERT_NAME" \
            -e community@example.org -f "$CERT_NAME"

          ./tizen-studio/tools/ide/bin/tizen security-profiles add \
            -n "$CERT_NAME" \
            -a "./tizen-studio-data/keystore/author/${CERT_NAME}.p12" \
            -p "$CERT_PASSWORD"

          ./tizen-studio/tools/ide/bin/tizen cli-config \
            "profiles.path=./tizen-studio-data/profile/profiles.xml"

      - name: Create expect script
        run: |
          printf '%s\n' \
            '#!/usr/bin/expect -f' \
            'set timeout 300' \
            'set build_dir [lindex $argv 0]' \
            'spawn $env(TIZEN_PATH)/tools/ide/bin/tizen package -t wgt -s CommunityPack -- $build_dir' \
            'expect {' \
            '  "Author password:" { send "$env(CERT_PASSWORD)\r"; exp_continue }' \
            '  "Distributor1 password:" { send "$env(CERT_PASSWORD)\r"; exp_continue }' \
            '  eof' \
            '}' \
            > package.exp
          chmod +x package.exp

      - uses: actions/upload-artifact@v4
        with:
          name: tizen-studio-artifact
          path: tizen-studio/
          retention-days: 1

      - uses: actions/upload-artifact@v4
        with:
          name: package-exp-artifact
          path: package.exp
          retention-days: 1

  generate-matrix-build:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
      - id: set-matrix
        run: |
          matrix=$(jq -c \
            '{include: [to_entries[] | {
               repo: .key,
               branch: .value.branch,
               build_script: (.value.build_script // ""),
               build_args: (.value.build_args // "")
            }]}' repos-build.json)
          echo "matrix=$matrix" >> "$GITHUB_OUTPUT"

  tizen-build:
    runs-on: ubuntu-latest
    needs: [prepare, generate-matrix-build]

    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.generate-matrix-build.outputs.matrix).include }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: tizen-studio-artifact
          path: tizen-studio

      - uses: actions/download-artifact@v4
        with:
          name: package-exp-artifact
          path: .

      - name: Install VLC prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            help2man ragel nasm yasm meson \
            protobuf-compiler build-essential pkg-config \
            automake autoconf libtool libtool-bin gettext \
            cmake

      # ----------------------------------------------
      # ðŸ§© CACHE: VLC contrib & extras/tools
      # ----------------------------------------------
      - name: Restore VLC contrib cache
        id: vlc-contrib-cache
        uses: actions/cache@v4
        with:
          path: |
            build/vlc-tizen/vlc/contrib/tarballs
            build/vlc-tizen/vlc/extras/tools
          key: vlc-contrib-cache-4e0fa1b

      - name: Fix toolchain permissions after artifact restore
        run: |
          echo "ðŸ”§ Restoring execute bits for GCC toolchain"
          find tizen-studio -type f -path "*/bin/arm-linux-gnueabi-*" -exec chmod +x {} \;
          find tizen-studio -type f -path "*/libexec/gcc/*/cc1" -exec chmod +x {} \;
          find tizen-studio -type f -path "*/libexec/gcc/*/cc1plus" -exec chmod +x {} \;
      
          echo "ðŸ“Œ cc1 permissions:"
          find tizen-studio -name cc1 -exec ls -l {} \;

      - name: Fix toolchain permissions after artifact restore
        run: |
          echo "ðŸ”§ Restoring execute bits for GCC toolchain"
          find tizen-studio -type f -path "*/bin/arm-linux-gnueabi-*" -exec chmod +x {} \;
          find tizen-studio -type f -path "*/libexec/gcc/*/cc1" -exec chmod +x {} \;
          find tizen-studio -type f -path "*/libexec/gcc/*/cc1plus" -exec chmod +x {} \;

      - name: Install 32-bit compatibility libs (fix cross-toolchain execution)
        run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update
          sudo apt-get install -y libc6:i386 libstdc++6:i386 zlib1g:i386 libgcc1:i386

      - name: Clone and build project
        shell: bash
        env:
          TIZEN_SDK: ${{ github.workspace }}/tizen-studio
          TIZEN_PATH: ${{ github.workspace }}/tizen-studio
        run: |
          set -e
          mkdir -p "$GITHUB_WORKSPACE/wgt_files" build
          cd build

          git clone --depth 1 --branch "${{ matrix.branch }}" \
            "https://github.com/${{ matrix.repo }}.git"

          cd "$(basename "${{ matrix.repo }}")"
          repo_name="$(basename "${{ matrix.repo }}")"

          if [[ "$repo_name" != "vlc-tizen" ]]; then
            echo "Building standard web project..."
            "$TIZEN_PATH/tools/ide/bin/tizen" build-web || true
            "$TIZEN_PATH/tools/ide/bin/tizen" package \
              -t wgt -o "$GITHUB_WORKSPACE/wgt_files/" || true
            exit 0
          fi

          # ------------------------------------------------------
          #               VLC-TIZEN BUILD PATH (CLEAN FIXED)
          # ------------------------------------------------------
          echo "Building VLC-Tizen..."
          
          echo "Using Tizen SDK..."
          SYSROOT="$TIZEN_SDK/platforms/tizen-4.0/mobile/rootstraps/mobile-4.0-device.core"
          export SYSROOT
          echo "ðŸ”§ Using sysroot: $SYSROOT"
          
          # Force correct SDK identifiers
          printf '%s\n' "4.0" > "$TIZEN_SDK/sdk.version"
          printf '%s\n' "4.0" > "$TIZEN_SDK/sdk.info"
          
          # Proper pkg-config sysroot
          export PKG_CONFIG_SYSROOT_DIR="$SYSROOT"
          export PKG_CONFIG_PATH="$SYSROOT/usr/lib/pkgconfig:$SYSROOT/usr/share/pkgconfig"
          export PKG_CONFIG_LIBDIR="$PKG_CONFIG_PATH"
          
          # Clone VLC source
          if [[ ! -d vlc ]]; then
              git clone https://code.videolan.org/videolan/vlc.git vlc
              pushd vlc
              git checkout 4e0fa1b
              popd
          fi
          
          # ------------------------------------------------------
          # Pre-seed contrib tarballs
          # ------------------------------------------------------
          CONTRIB_DIR="vlc/contrib/tarballs"
          mkdir -p "$CONTRIB_DIR"
          
          download() {
              [[ -f "$CONTRIB_DIR/$1" ]] && { echo "âœ” Cached $1"; return; }
              echo "â¬‡ï¸ Downloading $1"
              curl -L --fail --retry 4 --retry-delay 2 "$2" -o "$CONTRIB_DIR/$1"
          }
          
          for F in "${!PKG_URLS[@]}"; do
              download "$F" "${PKG_URLS[$F]}"
          done
          
          echo "ðŸ§¹ Removing previous contrib build (avoids poisoned includes)"
          rm -rf vlc/contrib/contrib-tizen-arm-linux-gnueabi
          
          # ------------------------------------------------------
          # libass / freetype include patch â€” CORRECT FIX
          # ------------------------------------------------------
          echo "ðŸ”§ Patching libass freetype paths"
          
          sed -i \
              's|ASS_CFLAGS =|ASS_CFLAGS = -I$$(PREFIX)/include -I$$(PREFIX)/include/freetype2 |' \
              vlc/contrib/src/ass/rules.mak
          
          # Ensure freetype flags include correct root
          sed -i \
              's|FREETYPE_CFLAGS="|FREETYPE_CFLAGS="-I$$(PREFIX)/include/freetype2 |' \
              vlc/contrib/src/ass/rules.mak
          
          # ------------------------------------------------------
          # CLEAN CROSS COMPILER: remove Samsung DIBS contamination
          # ------------------------------------------------------
          echo "ðŸ” Locating GCC 4.9 cross toolchain..."
          
          GCC49_BIN=$(find "$TIZEN_SDK/tools" -type f -name arm-linux-gnueabi-gcc | head -n 1)
          
          if [[ -z "$GCC49_BIN" ]]; then
              echo "âŒ FATAL: GCC 4.9 cross-compiler not found"
              exit 1
          fi
          
          TOOLBIN=$(dirname "$GCC49_BIN")
          GCCROOT=$(dirname "$TOOLBIN")
          
          # Clean up specs
          clean_specs() {
              BIN="$1/arm-linux-gnueabi-gcc"
              SPECS="$1/specs-clean"
              [[ ! -f "$BIN" ]] && return
          
              echo "ðŸ§¹ Cleaning specs in $1"
              "$BIN" -dumpspecs > "$SPECS"
          
              sed -i '/\.dibs/d' "$SPECS"
              sed -i '/srib-dibs-builder/d' "$SPECS"
          
              # Apply ONLY to the active directory
              if [[ "$TOOLBIN" == "$1" ]]; then
                  export CC="$BIN -specs=$SPECS"
                  export CXX="$1/arm-linux-gnueabi-g++ -specs=$SPECS"
              fi
          }
          
          clean_specs "$TIZEN_SDK/tools/arm-linux-gnueabi-gcc-4.9/bin"
          clean_specs "$TIZEN_SDK/tools/data/tools/arm-linux-gnueabi-gcc-4.9/bin"
          
          export AR="$TOOLBIN/arm-linux-gnueabi-ar"
          export LD="$TOOLBIN/arm-linux-gnueabi-ld"
          export RANLIB="$TOOLBIN/arm-linux-gnueabi-ranlib"
          export STRIP="$TOOLBIN/arm-linux-gnueabi-strip"
          
          export PATH="$TOOLBIN:$GCCROOT/libexec/gcc/arm-linux-gnueabi/4.9.2:/usr/bin:/bin"
          
          # ------------------------------------------------------
          # Disable AC_RUN_IFELSE and AC_TRY_RUN for cross compile
          # ------------------------------------------------------
          mkdir -p vlc/contrib/m4
          cat << 'EOF' > vlc/contrib/m4/disable-run.m4
          AC_DEFUN([AC_TRY_RUN],[
            AC_MSG_NOTICE([Cross-compile: skipping run test])
            AS_VAR_SET($2, ["$3"])
          ])
          AC_DEFUN([AC_RUN_IFELSE],[
            AC_MSG_NOTICE([Cross-compile: skipping run test])
            ifelse([$3], , :, [$3])
          ])
          EOF
          
          export ACLOCAL_PATH="$PWD/vlc/contrib/m4:$PWD/vlc/extras/tools/m4"
          export AUTOM4TE_SUBDIRS="$PWD/vlc/contrib/m4"
          
          # Clean environment (BUT KEEP pkg-config!!)
          unset CPPFLAGS CFLAGS CXXFLAGS LDFLAGS
          unset CPATH C_INCLUDE_PATH CPLUS_INCLUDE_PATH LIBRARY_PATH
          
          # ------------------------------------------------------
          # RUN CONTRIB BUILD
          # ------------------------------------------------------
          echo "ðŸ›¡ Environment sanitized â€” starting contrib build"
          export VERBOSE=1 V=1 MAKEFLAGS="-j1" CCACHE_DISABLE=1
          
          ./buildall.sh -a armv7l || {
              echo "âŒ buildall.sh FAILED â€” locating REAL failing contrib module..."

              ROOT="vlc/contrib/contrib-tizen-arm-linux-gnueabi"

              FAILED_MODULE=$(find "$ROOT" -maxdepth 2 -name ".stamp-configure" | \
                  while read f; do
                      MOD=$(dirname "$f")
                      if [[ ! -f "$MOD/.stamp-build" ]]; then
                          echo "$MOD"
                      fi
                  done | head -n 1)

              if [[ -z "$FAILED_MODULE" ]]; then
                  echo "âš  Could not detect failing module via stamps â€” fallback."
                  FAILED_MODULE=$(find "$ROOT" -maxdepth 2 -type d ! -name ".*" | head -n 1)
              fi

              echo "ðŸ”¥ REAL failing module: $FAILED_MODULE"

              if [[ -f "$FAILED_MODULE/config.log" ]]; then
                  echo "ðŸ“„ FIRST 200 lines:"
                  sed -n '1,200p' "$FAILED_MODULE/config.log"

                  echo "ðŸ“„ LAST 200 lines:"
                  tail -n 200 "$FAILED_MODULE/config.log"
              else
                  echo "âš  No config.log (configure died before writing)"
              fi

              echo "ðŸ” Re-running make in failing module with full debug"
              make -C "$FAILED_MODULE" V=1 --debug=b || true

              echo "âŒ Stopping build."
              exit 1
          }


          echo "Packaging WGT..."
          expect "$GITHUB_WORKSPACE/package.exp" "$(pwd)" || true
          cp -r ./*.wgt "$GITHUB_WORKSPACE/wgt_files/" 2>/dev/null || true

      - uses: softprops/action-gh-release@v2
        with:
          tag_name: "community-${{ github.run_number }}"
          name: "Community Packages ${{ github.run_number }}"
          files: "wgt_files/*.wgt"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-release:
    runs-on: ubuntu-latest
    needs: tizen-build

    steps:
      - uses: actions/download-artifact@v4
        with:
          path: release-wgts

      - name: List files
        run: ls -R release-wgts || true

      - uses: softprops/action-gh-release@v2
        with:
          tag_name: "community-${{ github.run_number }}"
          name: "Community Packages ${{ github.run_number }}"
          files: "release-wgts/**/*.wgt"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
