name: Sync Tizen Community Packages

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

permissions:
  contents: write

env:
  TIZEN_STUDIO_VER: 4
  CERT_NAME: CommunityPack
  CERT_PASSWORD: 1234
  NODE_OPTIONS: --openssl-legacy-provider

jobs:

  prepare:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Restore Tizen SDK cache
        id: tizen-sdk-cache
        uses: actions/cache@v4
        with:
          path: tizen-studio
          key: tizen-web-sdk-4.0

      - name: Install base dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget zip git jq nodejs npm expect curl unzip

      - name: Download and install Tizen Studio WEB CLI
        if: steps.tizen-sdk-cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p tizen-studio
          curl -L -o tizen-installer \
            "https://github.com/PatrickSt1991/tizen-community-packages/releases/download/tizen-deps-5.5/web-cli_Tizen_Studio_4.0_ubuntu-64.bin"
          chmod +x tizen-installer
          ./tizen-installer --accept-license "${GITHUB_WORKSPACE}/tizen-studio"
          rm ./tizen-installer
          chmod -R +x tizen-studio

      - name: Save SDK to cache
        if: steps.tizen-sdk-cache.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: tizen-studio
          key: tizen-web-sdk-4.0

      - name: Create signing certificate
        run: |
          mkdir -p tizen-studio-data/keystore/author tizen-studio-data/profile
          ./tizen-studio/tools/ide/bin/tizen certificate \
            -a "$CERT_NAME" -p "$CERT_PASSWORD" \
            -c NL -s Community -ct World \
            -o "$CERT_NAME" -n "$CERT_NAME" \
            -e community@example.org -f "$CERT_NAME"

          ./tizen-studio/tools/ide/bin/tizen security-profiles add \
            -n "$CERT_NAME" \
            -a "./tizen-studio-data/keystore/author/${CERT_NAME}.p12" \
            -p "$CERT_PASSWORD"

          ./tizen-studio/tools/ide/bin/tizen cli-config \
            "profiles.path=./tizen-studio-data/profile/profiles.xml"

      - name: Create packaging expect script
        run: |
          printf '%s\n' \
            '#!/usr/bin/expect -f' \
            'set timeout 300' \
            'set build_dir [lindex $argv 0]' \
            'spawn $env(TIZEN_PATH)/tools/ide/bin/tizen package -t wgt -s CommunityPack -- $build_dir' \
            'expect {' \
            '  "Author password:" { send "$env(CERT_PASSWORD)\r"; exp_continue }' \
            '  "Distributor1 password:" { send "$env(CERT_PASSWORD)\r"; exp_continue }' \
            '  eof' \
            '}' \
            > package.exp
          chmod +x package.exp

      - uses: actions/upload-artifact@v4
        with:
          name: tizen-studio-artifact
          path: tizen-studio/
          retention-days: 1

      - uses: actions/upload-artifact@v4
        with:
          name: package-exp-artifact
          path: package.exp
          retention-days: 1


  generate-matrix-build:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}

    steps:
      - uses: actions/checkout@v4

      - id: set-matrix
        run: |
          matrix=$(jq -c \
            '{include: [to_entries[] | {
               repo: .key,
               branch: .value.branch,
               build_script: (.value.build_script // ""),
               build_args: (.value.build_args // ""),
               project_path: (.value.project_path // ".")
            }]}' repos-build.json)
          echo "matrix=$matrix" >> "$GITHUB_OUTPUT"


  tizen-build:
    runs-on: ubuntu-latest
    needs: [prepare, generate-matrix-build]

    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.generate-matrix-build.outputs.matrix).include }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: tizen-studio-artifact
          path: tizen-studio

      - uses: actions/download-artifact@v4
        with:
          name: package-exp-artifact
          path: .

      - name: Restore execute permissions
        run: chmod -R +x tizen-studio

      - name: Install runtime deps
        run: |
          sudo apt-get update
          sudo apt-get install -y expect

      - name: Build Tizen Web Project
        shell: bash
        env:
          TIZEN_PATH: ${{ github.workspace }}/tizen-studio
        run: |
          set -e
          mkdir -p build wgt_files
          cd build

          git clone --depth 1 --branch "${{ matrix.branch }}" \
            "https://github.com/${{ matrix.repo }}.git"

          repo_dir="$(basename "${{ matrix.repo }}")"
          cd "$repo_dir"

          cd "${{ matrix.project_path }}"

          echo "Building Tizen Web project in $(pwd)"
          "$TIZEN_PATH/tools/ide/bin/tizen" build-web

          echo "Packaging..."
          expect "$GITHUB_WORKSPACE/package.exp" "$(pwd)"

          cp -r ./*.wgt "$GITHUB_WORKSPACE/wgt_files/" || true


  external-downloads:
    runs-on: ubuntu-latest
    needs: tizen-build
    steps:
      - uses: actions/checkout@v4

      - name: Prepare folders
        run: mkdir -p external_wgts

      - name: Download WGTs from releases
        shell: bash
        run: |
          releases=$(jq -r '.releases | to_entries[] | "\(.key)"' repos-external.json)
          for repo in $releases; do
            echo "ðŸ”½ Downloading release assets for $repoâ€¦"
            api="https://api.github.com/repos/$repo/releases/latest"
            json=$(curl -s "$api")
            echo "$json" | jq -r '.assets[].browser_download_url' | \
              while read url; do
                [ -n "$url" ] || continue
                echo "Downloading $url"
                curl -L -o external_wgts/$(basename "$url") "$url"
              done
          done

      - name: Download WGTs from commit sources
        shell: bash
        run: |
          commits=$(jq -r '.commits | to_entries[] | "\(.key) \(.value)"' repos-external.json)
          while read repo branch; do
            [ -n "$repo" ] || continue
            echo "ðŸ”½ Downloading commit WGT for $repo ($branch)â€¦"

            tmp=$(mktemp -d)
            git clone --depth 1 --branch "$branch" "https://github.com/$repo.git" "$tmp"
            find "$tmp" -name "*.wgt" -exec cp {} external_wgts/ \;
            rm -rf "$tmp"
          done <<< "$commits"

      - uses: actions/upload-artifact@v4
        with:
          name: external-wgts
          path: external_wgts/


  publish-release:
    runs-on: ubuntu-latest
    needs: [tizen-build, external-downloads]

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: external-wgts
          path: external

      - uses: actions/download-artifact@v4
        with:
          name: tizen-studio-artifact
          path: studio

      - name: Gather all WGT files
        run: |
          mkdir -p final_wgts
          cp wgt_files/*.wgt final_wgts/ 2>/dev/null || true
          cp external/*.wgt final_wgts/ 2>/dev/null || true
          echo "Final WGT files:"
          ls -l final_wgts

      - uses: softprops/action-gh-release@v2
        with:
          tag_name: "community-${{ github.run_number }}"
          name: "Community Packages ${{ github.run_number }}"
          files: "final_wgts/*.wgt"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
