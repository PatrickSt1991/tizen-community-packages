name: Sync Tizen Community Packages

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write

env:
  TIZEN_STUDIO_VER: 5.5
  CERT_NAME: CommunityPack
  CERT_PASSWORD: 1234
  NODE_OPTIONS: --openssl-legacy-provider
  TIZEN_PATH: ${{ github.workspace }}/tizen-studio
  PACKAGE_EXP: ${{ github.workspace }}/package.exp
  RELEASE_TAG: community-${{ github.run_number }}
  RELEASE_NAME: "Community Packages ${{ github.run_number }}"

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      tizen_path: ${{ steps.set_tizen_path.outputs.path }}
      signing_script: ${{ steps.package_exp.outputs.path }}
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget zip git jq nodejs npm expect curl

      - name: Download and Install Tizen Studio
        run: |
          mkdir -p tizen-studio
          curl -L -o tizen-installer "https://download.tizen.org/sdk/Installer/tizen-studio_${TIZEN_STUDIO_VER}/web-cli_Tizen_Studio_${TIZEN_STUDIO_VER}_ubuntu-64.bin"
          chmod +x tizen-installer
          ./tizen-installer --accept-license "${GITHUB_WORKSPACE}/tizen-studio"
          rm ./tizen-installer
          chmod -R +x tizen-studio/tools/ide/bin

      - name: Install Native SDK components (for VLC)
        run: |
          echo "üì¶ Installing Tizen Native SDK toolchains..."
          $GITHUB_WORKSPACE/tizen-studio/package-manager/package-manager-cli.bin install \
            NativeCLI NativeToolchain-GCC-armv7hl NativeToolchain-GCC-x86 NativeToolchain-GCC-x86_64 \
            NativeToolchain-GCC-aarch64 NativeToolchain-GCC-armel
          echo "‚úÖ Native SDK toolchains installed."
          $GITHUB_WORKSPACE/tizen-studio/package-manager/package-manager-cli.bin list

      - name: Create Tizen Certificate
        run: |
          mkdir -p tizen-studio-data/keystore/author tizen-studio-data/profile
          ./tizen-studio/tools/ide/bin/tizen certificate -a $CERT_NAME -p $CERT_PASSWORD \
            -c NL -s Community -ct World -o $CERT_NAME -n $CERT_NAME -e community@example.org \
            -f ${CERT_NAME}
          ./tizen-studio/tools/ide/bin/tizen security-profiles add -n $CERT_NAME \
            -a ./tizen-studio-data/keystore/author/${CERT_NAME}.p12 -p $CERT_PASSWORD
          ./tizen-studio/tools/ide/bin/tizen cli-config "profiles.path=./tizen-studio-data/profile/profiles.xml"

      - name: Create expect script for signing
        id: package_exp
        run: |
          cat > ${GITHUB_WORKSPACE}/package.exp << 'EXPEOF'
          #!/usr/bin/expect -f
          set timeout 300
          set build_dir [lindex $argv 0]
          spawn $env(GITHUB_WORKSPACE)/tizen-studio/tools/ide/bin/tizen package -t wgt -s CommunityPack -- $build_dir
          expect {
              "Author password:" { send "$env(CERT_PASSWORD)\r"; exp_continue }
              "Save author password" { send "n\r"; exp_continue }
              "Distributor1 password:" { send "$env(CERT_PASSWORD)\r"; exp_continue }
              "Save distributor1 password" { send "n\r"; exp_continue }
              eof
          }
          EXPEOF
          chmod +x ${GITHUB_WORKSPACE}/package.exp
          echo "path=${GITHUB_WORKSPACE}/package.exp" >> $GITHUB_OUTPUT

      - name: Set Tizen path output
        id: set_tizen_path
        run: echo "path=${GITHUB_WORKSPACE}/tizen-studio" >> $GITHUB_OUTPUT

      - name: Cache Tizen Studio and signing script
        uses: actions/cache@v4
        with:
          path: |
            tizen-studio/
            package.exp
          key: tizen-${{ env.TIZEN_STUDIO_VER }}-${{ runner.os }}

  generate-matrix-build:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
      - id: set-matrix
        run: |
          matrix=$(jq -c '{include: [to_entries[] | {
            repo: .key,
            branch: .value.branch,
            build_script: (.value.build_script // ""),
            build_args: (.value.build_args // ""),
            skip_npm: (.value.skip_npm // false)
          }]}' repos-build.json)
          echo "matrix=$matrix" >> $GITHUB_OUTPUT
          echo "Generated matrix: $matrix"

  sync:
    runs-on: ubuntu-latest
    needs: prepare
    env:
      RELEASE_TAG: ${{ env.RELEASE_TAG }}
      RELEASE_NAME: ${{ env.RELEASE_NAME }}
    steps:
      - uses: actions/checkout@v4

      - name: Restore Tizen Studio and signing script from cache
        uses: actions/cache@v4
        with:
          path: |
            tizen-studio/
            package.exp
          key: tizen-${{ env.TIZEN_STUDIO_VER }}-${{ runner.os }}

      - name: Restore permissions for Tizen tools
        run: |
          chmod -R +x tizen-studio/tools/ide/bin || true
          chmod +x package.exp || true

      - name: Download release-based WGTs
        run: |
          mkdir -p wgt_files
          declare -A repos=(
            ["OneLiberty/moonlight-chrome-tizen"]="release"
            ["MrPhaze62/moonlight-chrome-tizen-no-gamemode"]="release"
            ["PatrickSt1991/Sportlink.Club.Info.Viewer"]="release"
            ["reisxd/TizenBrew"]="release"
          )
          for repo in "${!repos[@]}"; do
            api="https://api.github.com/repos/$repo/releases/latest"
            latest_tag=$(curl -s $api | jq -r '.tag_name // empty')
            [ -z "$latest_tag" ] && continue
            assets=$(curl -s $api | jq -r '.assets[]?.browser_download_url // empty')
            for url in $assets; do
              if [[ "$url" == *.wgt ]]; then
                username=$(echo "$repo" | cut -d'/' -f1)
                appname=$(basename "$repo" | sed 's/-tizen//;s/-no-gamemode//;s/-chrome//;s/-//g;')
                filename="${username}-${appname}.wgt"
                echo "‚¨áÔ∏è Downloading $filename"
                wget -q -O "wgt_files/$filename" "$url"
              fi
            done
          done

      - name: Upload WGTS to unified release
        if: success()
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: ${{ env.RELEASE_NAME }}
          files: "wgt_files/*.wgt"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  tizen-build:
    runs-on: ubuntu-latest
    needs: [prepare, generate-matrix-build]
    env:
      RELEASE_TAG: ${{ env.RELEASE_TAG }}
      RELEASE_NAME: ${{ env.RELEASE_NAME }}
    strategy:
      matrix: ${{ fromJson(needs.generate-matrix-build.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4

      - name: Restore Tizen Studio and signing script from cache
        uses: actions/cache@v4
        with:
          path: |
            tizen-studio/
            package.exp
          key: tizen-${{ env.TIZEN_STUDIO_VER }}-${{ runner.os }}

      - name: Restore permissions and verify setup
        run: |
          chmod -R +x tizen-studio/tools/ide/bin || true
          chmod +x package.exp || true
          test -x tizen-studio/tools/ide/bin/tizen || { echo "‚ùå Tizen binary missing"; exit 1; }
          test -x package.exp || { echo "‚ùå package.exp missing"; exit 1; }

      - name: Clone and build project
        run: |
          mkdir -p "$GITHUB_WORKSPACE/wgt_files" build
          cd build
          repo="${{ matrix.repo }}"
          branch="${{ matrix.branch }}"
          build_script="${{ matrix.build_script }}"
          build_args="${{ matrix.build_args }}"
          skip_npm="${{ matrix.skip_npm }}"
          username=$(echo "$repo" | cut -d'/' -f1)
          appname=$(basename "$repo" | sed 's/-tizen//;s/-no-gamemode//;s/-chrome//;s/-//g;')
          output_name="${username}-${appname}.wgt"
          echo "Building $repo (branch: $branch) ‚Üí $output_name"

          n=0
          until [ $n -ge 3 ]; do
            git clone --depth 1 --single-branch --branch "$branch" "https://github.com/$repo.git" && break
            n=$((n+1))
            echo "Retrying clone... ($n)"
            sleep 5
          done

          cd "$(basename "$repo")" || { echo "‚ùå Failed to enter cloned repo directory"; exit 1; }

          export TIZEN_SDK="$TIZEN_PATH"
          export TIZEN_STUDIO="$TIZEN_PATH"
          export SYSROOT="$TIZEN_PATH/platforms/tizen-5.5/mobile/rootstraps/mobile-5.5-device.core"
          export PATH="$TIZEN_PATH/tools/arm-linux-gnueabi-gcc-4.9/bin:$PATH"

          if [ -n "$build_script" ] && [ -f "$build_script" ]; then
            chmod +x "$build_script"
            if [ -n "$build_args" ]; then
              "./$build_script" $build_args || { echo "‚ùå $build_script failed"; exit 1; }
            else
              "./$build_script" || { echo "‚ùå $build_script failed"; exit 1; }
            fi
            find . -name "*.wgt" -exec mv {} "$GITHUB_WORKSPACE/wgt_files/$output_name" \;
          elif [ "$skip_npm" = "true" ]; then
            "$TIZEN_PATH/tools/ide/bin/tizen" build-web || true
            "$PACKAGE_EXP" . || true
            find . -name "*.wgt" -exec mv {} "$GITHUB_WORKSPACE/wgt_files/$output_name" \;
          elif [ -f package.json ]; then
            npm ci --ignore-scripts --no-audit || npm install --no-audit
            npm run build --if-present || npm run package --if-present || true
            "$TIZEN_PATH/tools/ide/bin/tizen" build-web || true
            "$PACKAGE_EXP" . || true
            find . -name "*.wgt" -exec mv {} "$GITHUB_WORKSPACE/wgt_files/$output_name" \;
          else
            "$TIZEN_PATH/tools/ide/bin/tizen" build-web || true
            "$PACKAGE_EXP" . || true
            find . -name "*.wgt" -exec mv {} "$GITHUB_WORKSPACE/wgt_files/$output_name" \;
          fi

      - name: Upload WGTS to unified release
        if: success()
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: ${{ env.RELEASE_NAME }}
          files: "wgt_files/*.wgt"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
