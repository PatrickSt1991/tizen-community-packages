name: Sync Tizen Community Packages

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

permissions:
  contents: write

env:
  TIZEN_STUDIO_VER: 4
  CERT_NAME: CommunityPack
  CERT_PASSWORD: 1234
  NODE_OPTIONS: --openssl-legacy-provider

jobs:
  prepare:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget zip git jq nodejs npm expect curl unzip build-essential

      - name: Download and install Tizen Studio 4.0
        run: |
          mkdir -p tizen-studio
          curl -L -o tizen-installer "https://github.com/PatrickSt1991/tizen-community-packages/releases/download/tizen-deps-5.5/web-cli_Tizen_Studio_4.0_ubuntu-64.bin"
          chmod +x tizen-installer
          ./tizen-installer --accept-license "${GITHUB_WORKSPACE}/tizen-studio"
          rm ./tizen-installer
          chmod -R +x tizen-studio/tools/ide/bin

      - name: Install Tizen 4.0 Rootstrap and Toolchain
        run: |
          set -e
          echo "Downloading missing Tizen 4.0 components..."
          BASE_URL="https://download.tizen.org/sdk/tizenstudio/official/binary"
          WORKDIR="${GITHUB_WORKSPACE}/tizen-studio"

          echo "üì¶ Downloading rootstrap..."
          ROOTSTRAP_ZIP="mobile-4.0-rs-device.core_0.0.47_ubuntu-64.zip"
          curl -L -o "${WORKDIR}/rootstrap.zip" "$BASE_URL/$ROOTSTRAP_ZIP"

          echo "üìÇ Extracting rootstrap..."
          unzip -o "${WORKDIR}/rootstrap.zip" -d "${WORKDIR}/"

          echo "üìÅ Moving rootstrap to SDK location..."
          # After unzip we have: ${WORKDIR}/data/platforms/tizen-4.0/...
          mkdir -p "${WORKDIR}/platforms"
          mv "${WORKDIR}/data/platforms" "${WORKDIR}/platforms"
          rm -rf "${WORKDIR}/data"
          rm "${WORKDIR}/rootstrap.zip"

          echo "Installing GCC 4.9 Toolchain..."
          TOOLCHAIN_ZIP="cross-arm-gcc-4.9_1.1.0_ubuntu-64.zip"
          curl -L -o "${WORKDIR}/toolchain.zip" "$BASE_URL/$TOOLCHAIN_ZIP"
          unzip -o "${WORKDIR}/toolchain.zip" "data/tools/*" -d "${WORKDIR}/"
          mv "${WORKDIR}/data/tools/arm-linux-gnueabi-gcc-4.9" "${WORKDIR}/tools/"
          rm -rf "${WORKDIR}/data"
          rm "${WORKDIR}/toolchain.zip"

          echo "‚úÖ Rootstrap and Toolchain installed successfully."

      - name: Create signing certificate
        run: |
          mkdir -p tizen-studio-data/keystore/author tizen-studio-data/profile
          ./tizen-studio/tools/ide/bin/tizen certificate -a "$CERT_NAME" -p "$CERT_PASSWORD" \
            -c NL -s Community -ct World -o "$CERT_NAME" -n "$CERT_NAME" -e community@example.org -f "$CERT_NAME"
          ./tizen-studio/tools/ide/bin/tizen security-profiles add -n "$CERT_NAME" \
            -a "./tizen-studio-data/keystore/author/${CERT_NAME}.p12" -p "$CERT_PASSWORD"
          ./tizen-studio/tools/ide/bin/tizen cli-config "profiles.path=./tizen-studio-data/profile/profiles.xml"

      - name: Create expect script for signing
        run: |
          {
            echo '#!/usr/bin/expect -f'
            echo 'set timeout 300'
            echo 'set build_dir [lindex $argv 0]'
            echo 'spawn $env(TIZEN_PATH)/tools/ide/bin/tizen package -t wgt -s CommunityPack -- $build_dir'
            echo 'expect {'
            echo '  "Author password:" { send "$env(CERT_PASSWORD)\r"; exp_continue }'
            echo '  "Distributor1 password:" { send "$env(CERT_PASSWORD)\r"; exp_continue }'
            echo '  eof'
            echo '}'
          } > package.exp
          chmod +x package.exp

      - name: Install compiler shims (global)
        run: |
          TOOLCHAIN_BIN_DIR="${GITHUB_WORKSPACE}/tizen-studio/tools/arm-linux-gnueabi-gcc-4.9/bin"

          sudo mv "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-gcc" "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-gcc-real"
          sudo mv "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-g++" "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-g++-real"

          # gcc shim
          sudo tee "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-gcc" >/dev/null <<'EOF'
          #!/usr/bin/env bash
          for a in "$@"; do
            case "$a" in
              --sysroot=*) exec "$(dirname "$0")/arm-linux-gnueabi-gcc-real" "$@" ;;
            esac
          done
          exec gcc "$@"
          EOF
          
                    # g++ shim
                    sudo tee "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-g++" >/dev/null <<'EOF'
          #!/usr/bin/env bash
          for a in "$@"; do
            case "$a" in
              --sysroot=*) exec "$(dirname "$0")/arm-linux-gnueabi-g++-real" "$@" ;;
            esac
          done
          exec g++ "$@"
          EOF

          sudo chmod +x "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-gcc" "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-g++"

      - name: Upload Tizen Studio artifact
        uses: actions/upload-artifact@v4
        with:
          name: tizen-studio-artifact
          path: tizen-studio/
          retention-days: 1

      - name: Upload expect script artifact
        uses: actions/upload-artifact@v4
        with:
          name: package-exp-artifact
          path: package.exp
          retention-days: 1

  generate-matrix-build:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
      - id: set-matrix
        run: |
          matrix=$(jq -c '{include: [to_entries[] | {
            repo: .key,
            branch: .value.branch,
            build_script: (.value.build_script // ""),
            build_args: (.value.build_args // "")
          }]}' repos-build.json)
          echo "matrix=$matrix" >> "$GITHUB_OUTPUT"

  tizen-build:
    runs-on: ubuntu-latest
    needs: [prepare, generate-matrix-build]
    strategy:
      matrix: ${{ fromJson(needs.generate-matrix-build.outputs.matrix) }}
    env:
      TIZEN_PATH: ${{ github.workspace }}/tizen-studio
      PACKAGE_EXP: ${{ github.workspace }}/package.exp
  
    steps:
      - uses: actions/checkout@v4
  
      - name: Download Tizen Studio artifact
        uses: actions/download-artifact@v4
        with:
          name: tizen-studio-artifact
          path: tizen-studio/
  
      - name: Download expect script artifact
        uses: actions/download-artifact@v4
        with:
          name: package-exp-artifact
          path: ./
  
      - name: Make executables
        run: chmod -R +x tizen-studio/ && chmod +x package.exp
  
      - name: Clone and build project
        shell: bash
        run: |
          set -e
          mkdir -p "$GITHUB_WORKSPACE/wgt_files" build
          cd build
          git clone --depth 1 --branch "${{ matrix.branch }}" "https://github.com/${{ matrix.repo }}.git"
          cd "$(basename "${{ matrix.repo }}")"
  
          repo_name="$(basename "${{ matrix.repo }}")"
          echo "‚úÖ Building repository: $repo_name"
  
          if [[ "$repo_name" == "vlc-tizen" ]]; then
            echo "‚öôÔ∏è Using local Tizen Studio SDK..."
  
            export TIZEN_SDK="${TIZEN_PATH}"
            export TIZEN_SDK_VERSION="4.0"
  
            ROOTSTRAP="$TIZEN_PATH/platforms/tizen-4.0/mobile/rootstraps/mobile-4.0-device.core"
  
            if [ ! -d "$ROOTSTRAP" ]; then
              echo "‚ùå Rootstrap missing at: $ROOTSTRAP"
              ls -R "$TIZEN_PATH/platforms/tizen-4.0"
              exit 1
            fi
  
            echo "‚úÖ Rootstrap found."
  
            export SYSROOT="$ROOTSTRAP/usr"
            export CPPFLAGS="--sysroot=$SYSROOT -I$SYSROOT/include"
            export LDFLAGS="--sysroot=$SYSROOT -L$SYSROOT/lib"
            export PKG_CONFIG_PATH="$SYSROOT/lib/pkgconfig:$SYSROOT/usr/lib/pkgconfig"
            echo "üîß Using sysroot: $SYSROOT"
  
            TOOLCHAIN_BIN_DIR="$TIZEN_PATH/tools/arm-linux-gnueabi-gcc-4.9/bin"
  
            echo "üß© Ensuring compiler shims exist..."
            if [ ! -f "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-gcc-real" ]; then
              sudo mv "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-gcc" "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-gcc-real"
              sudo mv "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-g++" "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-g++-real"
            fi
  
            # GCC shim
            echo '#!/usr/bin/env bash' | sudo tee "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-gcc" >/dev/null
            echo 'for a in "$@"; do case "$a" in --sysroot=*) exec "$(dirname "$0")/arm-linux-gnueabi-gcc-real" "$@";; esac; done' | sudo tee -a "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-gcc" >/dev/null
            echo 'exec gcc "$@"' | sudo tee -a "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-gcc" >/dev/null
  
            # G++ shim
            echo '#!/usr/bin/env bash' | sudo tee "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-g++" >/dev/null
            echo 'for a in "$@"; do case "$a" in --sysroot=*) exec "$(dirname "$0")/arm-linux-gnueabi-g++-real" "$@";; esac; done' | sudo tee -a "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-g++" >/dev/null
            echo 'exec g++ "$@"' | sudo tee -a "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-g++" >/dev/null
  
            sudo chmod +x "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-gcc" "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-g++"
  
            build_script="${{ matrix.build_script }}"
            build_args="${{ matrix.build_args }}"
  
            if [ -n "$build_script" ] && [ -f "$build_script" ]; then
              chmod +x "$build_script"
              echo "üöß Running $build_script $build_args with host compilers..."
              CC=gcc CXX=g++ AR=ar LD=ld AS=as "./$build_script" $build_args || (
                echo "‚ùå Build failed, dumping config.log..."
                find . -name config.log -exec echo '---- {} ----' \; -exec tail -n 80 {} \;
                exit 1
              )
            else
              echo "‚ùå VLC build script not found!"
              exit 1
            fi
  
          else
            echo "üåê Standard web build for $repo_name..."
            "$TIZEN_PATH/tools/ide/bin/tizen" build-web || true
            "$PACKAGE_EXP" . || true
          fi
  
          username=$(echo "${{ matrix.repo }}" | cut -d'/' -f1)
          appname=$(basename "${{ matrix.repo }}" | sed 's/-tizen//')
          output_name="${username}-${appname}.wgt"
          find . -name "*.wgt" -exec mv {} "$GITHUB_WORKSPACE/wgt_files/$output_name" \;

      - name: Upload WGT artifact
        uses: actions/upload-artifact@v4
        with:
          name: wgt-${{ matrix.repo }}
          path: wgt_files/*.wgt

  publish-release:
    runs-on: ubuntu-latest
    needs: tizen-build
    steps:
      - name: Download all WGT artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-wgts

      - name: List downloaded files
        run: ls -R release-wgts || echo "No WGT files found"

      - name: Create GitHub Release with all WGTS
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "community-${{ github.run_number }}"
          name: "Community Packages ${{ github.run_number }}"
          files: "release-wgts/**/*.wgt"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
