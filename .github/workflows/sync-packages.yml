name: Sync Tizen Community Packages

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

permissions:
  contents: write

env:
  TIZEN_STUDIO_VER: 4
  CERT_NAME: CommunityPack
  CERT_PASSWORD: 1234
  NODE_OPTIONS: --openssl-legacy-provider

jobs:
  prepare:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # -----------------------------------------
      # ðŸ§© CACHE: Tizen SDK (massive time saver)
      # -----------------------------------------
      - name: Restore Tizen SDK cache
        id: tizen-sdk-cache
        uses: actions/cache@v4
        with:
          path: tizen-studio
          key: tizen-sdk-4.0

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            wget zip git jq nodejs npm expect curl unzip build-essential \
            libtool help2man ragel nasm protobuf-compiler meson

      - name: Download and install Tizen Studio 4.0
        if: steps.tizen-sdk-cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p tizen-studio
          curl -L -o tizen-installer "https://github.com/vlc-tizen/tizen-studio-install/releases/download/v1.1/tizen-studio-install-cli-Tizen-4.0.0.zip"
          unzip tizen-installer -d tizen-studio
          tizen-studio/install.sh --accept-license --no-install-repo --install-dir tizen-studio

      - name: Setup Tizen SDK
        run: |
          tizen-studio/tools/ide/bin/sdk-cli install -p 'all'
          tizen-studio/tools/ide/bin/sdk-cli install -e 'mobile-4.0'
          tizen-studio/tools/ide/bin/sdk-cli install -e 'mobile-4.0-emulator'

      - name: Prepare build environment
        run: |
          mkdir -p build
          mkdir -p wgt_files
          
      - name: Create package.exp
        run: |
          echo "set timeout 60
          spawn tizen-studio/tools/ide/bin/tizen package -t wgt -s ${CERT_NAME} -p ${CERT_PASSWORD} -d 
          expect \"Password:\"
          send \"${CERT_PASSWORD}\r\"
          expect eof" > package.exp
          
      - name: Create certificate
        run: |
          tizen-studio/tools/ide/bin/sdk-cli security create-profile -n ${CERT_NAME} -p ${CERT_PASSWORD}

      - name: Upload tizen-studio-artifact
        uses: actions/upload-artifact@v4
        with:
          name: tizen-studio-artifact
          path: tizen-studio
          
      - name: Upload package-exp-artifact
        uses: actions/upload-artifact@v4
        with:
          name: package-exp-artifact
          path: package.exp

  generate-matrix-build:
    runs-on: ubuntu-latest
    needs: prepare
    outputs:
      matrix: ${{ steps.generate.outputs.matrix }}
    steps:
      - id: generate
        run: |
          PACKAGES=$(echo '{"include": [
            {"repo": "TizenTeam/vlc-tizen", "ref": "tizen/4.0"},
            {"repo": "TizenTeam/gimp-tizen", "ref": "tizen/4.0"}
          ]}')
          echo "matrix=$PACKAGES" >> $GITHUB_OUTPUT
          
  tizen-build:
    runs-on: ubuntu-latest
    needs: [prepare, generate-matrix-build]

    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.generate-matrix-build.outputs.matrix).include }}

    steps:
      - uses: actions/checkout@v4
        with:
          repository: ${{ matrix.repo }}
          ref: ${{ matrix.ref }}
          path: build/${{ matrix.repo }}

      - uses: actions/download-artifact@v4
        with:
          name: tizen-studio-artifact
          path: tizen-studio

      - uses: actions/download-artifact@v4
        with:
          name: package-exp-artifact
          path: .

      - name: Install VLC prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            help2man ragel nasm yasm meson \
            protobuf-compiler build-essential pkg-config \
            automake autoconf libtool libtool-bin gettext \
            cmake
      
      # ----------------------------------------------
      # ðŸ§© CACHE: VLC contrib & extras/tools
      # ----------------------------------------------
      - name: Restore VLC contrib cache
        id: vlc-contrib-cache
        uses: actions/cache@v4
        with:
          path: |
            build/vlc-tizen/vlc/contrib/tarballs
            build/vlc-tizen/vlc/extras/tools
          key: vlc-contrib-cache-4e0fa1

      - name: Clone VLC and Prepare Build Directory
        if: ${{ matrix.repo == 'TizenTeam/vlc-tizen' }}
        run: |
          mkdir -p build/vlc-tizen
          cp -r build/TizenTeam/vlc-tizen/* build/vlc-tizen/
          rm -rf build/TizenTeam/vlc-tizen
          cd build/vlc-tizen
          
          # Initialize VLC git submodules
          git submodule update --init --recursive vlc
          
          # Create wrapper script directory
          mkdir -p gcc_wrapper

          # Create a minimal gcc wrapper script (not strictly necessary but defensive)
          echo '#!/bin/bash
          
          # Execute the actual compiler after path cleanup (mainly for safety)
          exec /usr/bin/env -u C_INCLUDE_PATH -u CPLUS_INCLUDE_PATH -u CPATH /usr/bin/gcc "$@"
          ' > gcc_wrapper/gcc
          chmod +x gcc_wrapper/gcc
          
          # Clean up previous contrib build to avoid poisoned includes/libs
          rm -rf vlc/contrib/contrib-tizen-arm-linux-gnueabi

      - name: Build VLC Contrib
        if: ${{ matrix.repo == 'TizenTeam/vlc-tizen' }}
        shell: bash
        env:
          TIZEN_SDK: ${{ github.workspace }}/tizen-studio
          TIZEN_PATH: ${{ github.workspace }}/tizen-studio
          
          # Set the cross-compiler environment variables
          SYSROOT: ${{ github.workspace }}/tizen-studio/platforms/tizen-4.0/mobile/rootstraps/mobile-4.0-device.core
          GCC_DIR: ${{ github.workspace }}/tizen-studio/tools/data/tools/arm-linux-gnueabi-gcc-4.9/bin
          
          # Set cross compiler flags that include the Tizen sysroot
          CFLAGS: -I${{ github.workspace }}/tizen-studio/platforms/tizen-4.0/mobile/rootstraps/mobile-4.0-device.core/usr/include
          CXXFLAGS: -I${{ github.workspace }}/tizen-studio/platforms/tizen-4.0/mobile/rootstraps/mobile-4.0-device.core/usr/include
          LDFLAGS: -L${{ github.workspace }}/tizen-studio/platforms/tizen-4.0/mobile/rootstraps/mobile-4.0-device.core/usr/lib
          
        run: |
          set -e
          cd build/vlc-tizen
          
          # Define host compiler path to bypass any aliases or hidden shell pollution
          GCC_WRAPPER_DIR=$(pwd)/gcc_wrapper
          
          # ------------------------------------------------------------------
          # ðŸ’¥ CRITICAL: AGGRESSIVE CLEANUP OF POLLUTING DIBS PATHS
          # This must run before any build scripts.
          # ------------------------------------------------------------------
          echo "ðŸ’¥ FIX: Setting clean host compiler vars and aggressively unsetting DIBS path pollution."

          # 1. Define clean host compiler vars (used by contrib for native tools)
          # Use '/usr/bin/env -u ...' to guarantee a clean execution environment for the host compiler.
          # Explicitly unsetting more variables that might be polluted.
          export CC_FOR_BUILD="/usr/bin/env -u C_INCLUDE_PATH -u CPLUS_INCLUDE_PATH -u CPATH -u LD_LIBRARY_PATH -u LIBRARY_PATH gcc"
          export CXX_FOR_BUILD="/usr/bin/env -u C_INCLUDE_PATH -u CPLUS_INCLUDE_PATH -u CPATH -u LD_LIBRARY_PATH -u LIBRARY_PATH g++"
          export CFLAGS_FOR_BUILD=""
          export CPPFLAGS_FOR_BUILD=""
          export LDFLAGS_FOR_BUILD=""
          
          # 2. Also unset CPATH variables globally in the current shell
          unset C_INCLUDE_PATH || true
          unset CPLUS_INCLUDE_PATH || true
          unset CPATH || true
          unset LD_LIBRARY_PATH || true
          unset LIBRARY_PATH || true

          # 3. Aggressively clean cross-compiler flags of DIBS paths (if they leaked into ENV)
          export CFLAGS=$(echo "$CFLAGS" | sed 's|-I/root/\.dibs[^ ]*||g')
          export CPPFLAGS=$(echo "$CPPFLAGS" | sed 's|-I/root/\.dibs[^ ]*||g')
          export CXXFLAGS=$(echo "$CXXFLAGS" | sed 's|-I/root/\.dibs[^ ]*||g')
          export LDFLAGS=$(echo "$LDFLAGS" | sed 's|-L/root/\.dibs[^ ]*||g')
          # ------------------------------------------------------------------
          
          # Execute contrib build
          vlc/extras/tools/build-contrib.sh -a armv7l || {
            echo "âŒ Contrib build FAILED!"
            exit 1
          }

          # Save cache
          echo "vlc-contrib-cache-4e0fa1" > build/vlc-tizen/vlc/contrib/.cached_key
          
      - name: Cross-Compile Test and Run Build
        if: ${{ matrix.repo == 'TizenTeam/vlc-tizen' }}
        shell: bash
        env:
          TIZEN_SDK: ${{ github.workspace }}/tizen-studio
          TIZEN_PATH: ${{ github.workspace }}/tizen-studio
        run: |
          set -e
          cd build/vlc-tizen

          # Redefine all necessary variables and PATH for this final step
          SYSROOT="$TIZEN_SDK/platforms/tizen-4.0/mobile/rootstraps/mobile-4.0-device.core"
          GCC_ROOT="$TIZEN_SDK/tools/data/tools/arm-linux-gnueabi-gcc-4.9"
          GCC_DIR="$GCC_ROOT/bin"
          GCC_BIN="$GCC_DIR/arm-linux-gnueabi-gcc"
          GCC_PLUS_BIN="$GCC_DIR/arm-linux-gnueabi-g++"
          TARGET_TUPLE=arm-linux-gnueabi

          GCC_WRAPPER_DIR=$(pwd)/gcc_wrapper

          # Re-establish PATH with wrapper (must be first) and ARM toolchain
          export PATH="$GCC_WRAPPER_DIR:$GCC_DIR:$PATH"
          hash -r

          # Re-establish ARM toolchain variables
          export AS="$GCC_DIR/arm-linux-gnueabi-as"
          export LD="$GCC_DIR/arm-linux-gnueabi-ld"
          export AR="$GCC_DIR/arm-linux-gnueabi-ar"
          export NM="$GCC_DIR/arm-linux-gnueabi-nm"
          export RANLIB="$GCC_DIR/arm-linux-gnueabi-ranlib"
          export STRIP="$GCC_DIR/arm-linux-gnueabi-strip"

          # ------------------------------------------------------------------
          # ðŸ’¥ CRITICAL: AGGRESSIVE CLEANUP OF POLLUTING DIBS PATHS (REPEATED FOR SAFETY)
          # ------------------------------------------------------------------
          echo "ðŸ’¥ FIX: Setting clean host compiler vars and aggressively unsetting DIBS path pollution."

          # 1. Define clean host compiler vars (used by VLC for native tools)
          # Ensure this is defined here, as this step is a new shell.
          export CC_FOR_BUILD="/usr/bin/env -u C_INCLUDE_PATH -u CPLUS_INCLUDE_PATH -u CPATH -u LD_LIBRARY_PATH -u LIBRARY_PATH gcc"
          export CXX_FOR_BUILD="/usr/bin/env -u C_INCLUDE_PATH -u CPLUS_INCLUDE_PATH -u CPATH -u LD_LIBRARY_PATH -u LIBRARY_PATH g++"
          export CFLAGS_FOR_BUILD=""
          export CPPFLAGS_FOR_BUILD=""
          export LDFLAGS_FOR_BUILD=""
          
          # 2. Also unset CPATH variables globally in the current shell
          unset C_INCLUDE_PATH || true
          unset CPLUS_INCLUDE_PATH || true
          unset CPATH || true
          unset LD_LIBRARY_PATH || true
          unset LIBRARY_PATH || true

          # 3. Aggressively clean cross-compiler flags of DIBS paths (if they leaked into ENV)
          export CFLAGS=$(echo "$CFLAGS" | sed 's|-I/root/\.dibs[^ ]*||g')
          export CPPFLAGS=$(echo "$CPPFLAGS" | sed 's|-I/root/\.dibs[^ ]*||g')
          export CXXFLAGS=$(echo "$CXXFLAGS" | sed 's|-I/root/\.dibs[^ ]*||g')
          export LDFLAGS=$(echo "$LDFLAGS" | sed 's|-L/root/\.dibs[^ ]*||g')
          # ------------------------------------------------------------------

          export VERBOSE=1 V=1 MAKEFLAGS="-j1" CCACHE_DISABLE=1
          
          echo "ðŸ”§ Enforcing real ARM toolchain for CC/CXX"
          # CC/CXX must be the full command including sysroot for proper cross-compilation
          export CC="$GCC_BIN --sysroot=$SYSROOT -B$GCC_DIR"
          export CXX="$GCC_PLUS_BIN --sysroot=$SYSROOT -B$GCC_DIR"

          # Final Cross-Compile Test (Keep this test for verification)
          cd vlc || true
          echo 'int main(){return 0;}' > test.c

          echo "==== Running: $CC test.c -o test.out -v ===="
          $CC test.c -o test.out -v || {
            echo "âŒ CROSS-COMPILER FAILED â€” THIS IS WHY configure SAYS 'cannot create executables'"
            exit 1
          }

          echo "==== SUCCESS: cross compiler created test.out ===="
          ls -l test.out || true
          cd ..

          # Final patches before running buildall.sh
          echo "ðŸ”§ Patching vlc/contrib/src/main.mak"
          # CRITICAL: HOST_CC/CXX must be the clean host compiler for sanity checks
          sed -i "1i HOST_CC := \$(CC_FOR_BUILD)" vlc/contrib/src/main.mak
          sed -i "2i HOST_CXX := \$(CXX_FOR_BUILD)" vlc/contrib/src/main.mak
          
          # Force ARM binutils for the contrib dependencies
          sed -i "3i AS := ${GCC_DIR}/arm-linux-gnueabi-as" vlc/contrib/src/main.mak
          sed -i "4i LD := ${GCC_DIR}/arm-linux-gnueabi-ld" vlc/contrib/src/main.mak
          sed -i "5i AR := ${GCC_DIR}/arm-linux-gnueabi-ar" vlc/contrib/src/main.mak
          sed -i "6i NM := ${GCC_DIR}/arm-linux-gnueabi-nm" vlc/contrib/src/main.mak
          sed -i "7i RANLIB := ${GCC_DIR}/arm-linux-gnueabi-ranlib" vlc/contrib/src/main.mak
          sed -i "8i STRIP := ${GCC_DIR}/arm-linux-gnueabi-strip" vlc/contrib/src/main.mak
          sed -i "9i PATH := ${GCC_DIR}:\$(PATH)\n" vlc/contrib/src/main.mak

          # Clean up remaining DIBS paths in config files
          sed -i 's|-I/root/\.dibs[^ ]*||g' vlc/contrib/config.mak || true
          sed -i 's|/root/\.dibs[^ ]*||g' vlc/contrib/config.mak || true
          sed -i 's|-I/root/\.dibs[^ ]*||g' vlc/contrib/src/main.mak || true
          
          echo "ðŸ”§ Starting buildall.sh"
          export VERBOSE=1 V=1 MAKEFLAGS="-j1" CCACHE_DISABLE=1

          # Build VLC core
          ./buildall.sh -a armv7l || {
              echo "âŒ buildall.sh FAILED â€” locating REAL failing contrib module..."

              ROOT="vlc/contrib/contrib-tizen-arm-linux-gnueabi"

              FAILED_MODULE=$(find "$ROOT" -maxdepth 2 -name ".stamp-configure" | \
                  while read f; do
                      MOD=$(dirname "$f")
                      if [[ ! -f "$MOD/.stamp-build" ]]; then
                          echo "$MOD"
                      fi
                  done | head -n 1)

              if [[ -z "$FAILED_MODULE" ]]; then
                  echo "âš  Could not detect failing module via stamps â€” fallback."
                  FAILED_MODULE=$(find "$ROOT" -maxdepth 2 -type d ! -name ".*" | head -n 1)
              fi

              echo "ðŸ”¥ REAL failing module: $FAILED_MODULE"

              if [[ -f "$FAILED_MODULE/config.log" ]]; then
                  echo "ðŸ“„ FIRST 200 lines:"
                  sed -n '1,200p' "$FAILED_MODULE/config.log"

                  echo "ðŸ“„ LAST 200 lines:"
                  tail -n 200 "$FAILED_MODULE/config.log"
              else
                  echo "âš  No config.log (configure died before writing)"
              fi

              echo "ðŸ” Re-running make in failing module with full debug"
              make -C "$FAILED_MODULE" V=1 --debug=b || true

              echo "âŒ Stopping build."
              exit 1
          }

          echo "Packaging WGT..."
          expect "$GITHUB_WORKSPACE/package.exp" "$(pwd)" || true
          cp -r ./*.wgt "$GITHUB_WORKSPACE/wgt_files/" 2>/dev/null || true

      - uses: softprops/action-gh-release@v2
        with:
          tag_name: "community-${{ github.run_number }}"
          name: "Community Packages ${{ github.run_number }}"
          files: "wgt_files/*.wgt"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-release:
    runs-on: ubuntu-latest
    needs: tizen-build

    steps:
      - uses: actions/download-artifact@v4
        with:
          path: release-wgts

      - name: List files
        run: ls -R release-wgts || true

      - uses: actions/upload-artifact@v4
        with:
          name: release-wgts
          path: release-wgts
