name: Sync Tizen Community Packages

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write

env:
  TIZEN_STUDIO_VER: 5.5
  CERT_NAME: CommunityPack
  CERT_PASSWORD: 1234
  NODE_OPTIONS: --openssl-legacy-provider
  TIZEN_PATH: ${{ github.workspace }}/tizen-studio
  PACKAGE_EXP: ${{ github.workspace }}/package.exp

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      tizen_path: ${{ steps.set_tizen_path.outputs.path }}
      signing_script: ${{ steps.package_exp.outputs.path }}

    steps:
      - uses: actions/checkout@v4

      # Restore cached Tizen Studio and signing script if available
      - name: Restore Tizen Studio cache
        uses: actions/cache@v4
        with:
          path: |
            tizen-studio/
            tizen-studio-data/
            package.exp
          key: tizen-${{ env.TIZEN_STUDIO_VER }}-${{ runner.os }}

      - name: Install dependencies
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y wget zip git jq nodejs npm expect curl unzip

      - name: Download and Install Tizen Studio 5.5 (if not cached)
        run: |
          set -e
          if [ ! -d "${GITHUB_WORKSPACE}/tizen-studio" ] || [ ! -x "${GITHUB_WORKSPACE}/tizen-studio/tools/ide/bin/tizen" ]; then
            mkdir -p tizen-studio
            curl -L -o tizen-installer "https://download.tizen.org/sdk/Installer/tizen-studio_${TIZEN_STUDIO_VER}/web-cli_Tizen_Studio_${TIZEN_STUDIO_VER}_ubuntu-64.bin"
            chmod +x tizen-installer
            ./tizen-installer --accept-license "${GITHUB_WORKSPACE}/tizen-studio"
            rm ./tizen-installer
            chmod -R +x tizen-studio/tools/ide/bin
          fi

      - name: Install base SDK components and platform
        run: |
          set -e
          CLI="${GITHUB_WORKSPACE}/tizen-studio/package-manager/package-manager-cli.bin"
          chmod +x "$CLI"
          # Install CLI and Mobile 5.5 platform (TV 5.5 is not present in the public repo)
          "$CLI" install --accept-license WebCLI NativeCLI MOBILE-5.5-NativeAppDevelopment
          # Show platforms and rootstraps so we can confirm paths
          echo "Installed platforms and rootstraps:"
          if [ -d "${GITHUB_WORKSPACE}/tizen-studio/platforms" ]; then
            find "${GITHUB_WORKSPACE}/tizen-studio/platforms" -maxdepth 4 -type d
          else
            echo "No platforms directory found."
          fi

      - name: Create Tizen Certificate
        run: |
          set -e
          mkdir -p tizen-studio-data/keystore/author tizen-studio-data/profile
          ./tizen-studio/tools/ide/bin/tizen certificate -a "$CERT_NAME" -p "$CERT_PASSWORD" \
            -c NL -s Community -ct World -o "$CERT_NAME" -n "$CERT_NAME" -e community@example.org -f "$CERT_NAME"
          ./tizen-studio/tools/ide/bin/tizen security-profiles add -n "$CERT_NAME" \
            -a "./tizen-studio-data/keystore/author/${CERT_NAME}.p12" -p "$CERT_PASSWORD"
          ./tizen-studio/tools/ide/bin/tizen cli-config "profiles.path=./tizen-studio-data/profile/profiles.xml"

      - name: Create expect script for signing
        id: package_exp
        shell: bash
        run: |
          set -e
          cat > "${GITHUB_WORKSPACE}/package.exp" <<'EOF'
#!/usr/bin/expect -f
set timeout 300
set build_dir [lindex $argv 0]
spawn $env(GITHUB_WORKSPACE)/tizen-studio/tools/ide/bin/tizen package -t wgt -s CommunityPack -- $build_dir
expect {
    "Author password:" { send "$env(CERT_PASSWORD)\r"; exp_continue }
    "Save author password" { send "n\r"; exp_continue }
    "Distributor1 password:" { send "$env(CERT_PASSWORD)\r"; exp_continue }
    "Save distributor1 password" { send "n\r"; exp_continue }
    eof
}
EOF
          chmod +x "${GITHUB_WORKSPACE}/package.exp"
          echo "path=${GITHUB_WORKSPACE}/package.exp" >> "$GITHUB_OUTPUT"

      - name: Set Tizen path output
        id: set_tizen_path
        run: echo "path=${GITHUB_WORKSPACE}/tizen-studio" >> "$GITHUB_OUTPUT"

      # Save cache for future runs
      - name: Save Tizen Studio cache
        uses: actions/cache@v4
        with:
          path: |
            tizen-studio/
            tizen-studio-data/
            package.exp
          key: tizen-${{ env.TIZEN_STUDIO_VER }}-${{ runner.os }}

  generate-matrix-build:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
      - id: set-matrix
        run: |
          set -e
          matrix=$(jq -c '{include: [to_entries[] | {
            repo: .key,
            branch: .value.branch,
            build_script: (.value.build_script // ""),
            build_args: (.value.build_args // ""),
            skip_npm: (.value.skip_npm // false)
          }]}' repos-build.json)
          echo "matrix=$matrix" >> "$GITHUB_OUTPUT"

  sync:
    runs-on: ubuntu-latest
    needs: prepare
    outputs:
      release_tag: ${{ steps.tag.outputs.tag }}
    steps:
      - uses: actions/checkout@v4

      - name: Create unified release tag
        id: tag
        run: |
          set -e
          tag="community-${GITHUB_RUN_NUMBER}-$(date +%Y%m%d-%H%M%S)"
          echo "tag=$tag" >> "$GITHUB_OUTPUT"

      - name: Download WGTs from repos-sync.json
        run: |
          set -e
          mkdir -p wgt_files
          jq -c '.releases | to_entries[]' repos-sync.json | while read -r entry; do
            repo=$(echo "$entry" | jq -r '.key')
            api="https://api.github.com/repos/$repo/releases/latest"
            latest_tag=$(curl -s "$api" | jq -r '.tag_name // empty')
            [ -z "$latest_tag" ] && continue
            assets=$(curl -s "$api" | jq -r '.assets[]?.browser_download_url // empty')
            for url in $assets; do
              if [[ "$url" == *.wgt ]]; then
                username=$(echo "$repo" | cut -d'/' -f1)
                appname=$(basename "$repo" | sed 's/-tizen//;s/-chrome//;s/-no-gamemode//;s/-//g')
                filename="${username}-${appname}.wgt"
                wget -q -O "wgt_files/$filename" "$url"
              fi
            done
          done

      - name: Upload WGTS to unified release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: "Community Packages ${{ github.run_number }}"
          files: "wgt_files/*.wgt"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  tizen-build:
    runs-on: ubuntu-latest
    needs: [prepare, generate-matrix-build, sync]
    strategy:
      matrix: ${{ fromJson(needs.generate-matrix-build.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4

      - name: Restore Tizen Studio cache
        uses: actions/cache@v4
        with:
          path: |
            tizen-studio/
            tizen-studio-data/
            package.exp
          key: tizen-${{ env.TIZEN_STUDIO_VER }}-${{ runner.os }}

      - name: Install VLC build prerequisites
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y \
            build-essential autoconf automake autopoint bison flex \
            gettext pkg-config help2man nasm yasm cmake ninja-build \
            python3 python3-pip python3-setuptools python3-wheel \
            libtool libprotobuf-dev protobuf-compiler \
            zlib1g-dev libssl-dev libxml2-dev libxslt1-dev \
            libasound2-dev libpulse-dev libc6-dev

      - name: Debug: List installed Tizen rootstraps
        run: |
          set -e
          echo "Scanning ${TIZEN_PATH}/platforms for rootstraps..."
          if [ -d "${TIZEN_PATH}/platforms" ]; then
            find "${TIZEN_PATH}/platforms" -maxdepth 4 -type d
          else
            echo "No platforms directory found at ${TIZEN_PATH}/platforms"
          fi

      - name: Clone and build project
        shell: bash
        run: |
          set -e
          mkdir -p "${GITHUB_WORKSPACE}/wgt_files" build
          cd build
          repo="${{ matrix.repo }}"
          branch="${{ matrix.branch }}"
          build_script="${{ matrix.build_script }}"
          build_args="${{ matrix.build_args }}"
          username=$(echo "$repo" | cut -d'/' -f1)
          appname=$(basename "$repo" | sed 's/-tizen//;s/-chrome//;s/-no-gamemode//;s/-//g')
          output_name="${username}-${appname}.wgt"

          echo "Cloning $repo ($branch)..."
          git clone --depth 1 --single-branch --branch "$branch" "https://github.com/$repo.git"
          cd "$(basename "$repo")"

          # noexec-safe wrapper
          cat > /usr/local/bin/run_with_tmpdir <<'EOS'
#!/bin/bash
export TMPDIR=/tmp
export TEMPDIR=/tmp
export CONFIG_SHELL=/bin/bash
exec "$@"
EOS
          chmod +x /usr/local/bin/run_with_tmpdir

          # GCC sanity check
          echo 'int main(){return 0;}' > /tmp/test.c
          gcc /tmp/test.c -o /tmp/test.out
          [ -x /tmp/test.out ]

          # For VLC: set Mobile 5.5 rootstrap as fallback since TV 5.5 is not present
          if [[ "$repo" == "TizenTeam/vlc-tizen" ]]; then
            export TIZEN_VER=5.5
            export PATH="${TIZEN_PATH}/tools/arm-linux-gnueabi-gcc-4.9/bin:${PATH}"
            export TIZEN_ROOTSTRAP="${TIZEN_PATH}/platforms/tizen-${TIZEN_VER}/mobile/rootstraps/mobile-${TIZEN_VER}-device.core"
            echo "Using rootstrap: ${TIZEN_ROOTSTRAP}"
            if [ ! -d "${TIZEN_ROOTSTRAP}" ]; then
              echo "Rootstrap not found at ${TIZEN_ROOTSTRAP}"
              exit 1
            fi
            export CC=arm-linux-gnueabi-gcc
            export CXX=arm-linux-gnueabi-g++
          fi

          if [ -n "$build_script" ] && [ -f "$build_script" ]; then
            chmod +x "$build_script"
            echo "Running $build_script $build_args..."
            run_with_tmpdir "./$build_script" $build_args || (
              echo "Build failed, dumping config.log..."
              find . -name config.log -exec echo '---- {} ----' \; -exec tail -n 80 {} \;
              exit 1
            )
            find . -name "*.wgt" -exec mv {} "${GITHUB_WORKSPACE}/wgt_files/${output_name}" \;
          else
            "${TIZEN_PATH}/tools/ide/bin/tizen" build-web || true
            "${PACKAGE_EXP}" . || true
            find . -name "*.wgt" -exec mv {} "${GITHUB_WORKSPACE}/wgt_files/${output_name}" \;
          fi

      - name: Upload WGTS to unified release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.sync.outputs.release_tag }}
          name: "Community Packages ${{ github.run_number }}"
          files: "wgt_files/*.wgt"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}