name: Sync Tizen Community Packages

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs: {}

permissions:
  contents: write

env:
  TIZEN_STUDIO_VER: 5.5
  CERT_NAME: CommunityPack
  CERT_PASSWORD: 1234
  NODE_OPTIONS: --openssl-legacy-provider

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      tizen_path: ${{ steps.set_tizen_path.outputs.path }}
      signing_script: ${{ steps.package_exp.outputs.path }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget zip git jq nodejs npm expect curl openjdk-11-jdk

      - name: Download Tizen Studio Installer
        run: |
          curl -o tizen-installer "https://download.tizen.org/sdk/Installer/tizen-studio_${TIZEN_STUDIO_VER}/web-cli_Tizen_Studio_${TIZEN_STUDIO_VER}_ubuntu-64.bin"
          chmod +x tizen-installer

      - name: Install Tizen Studio
        run: |
          ./tizen-installer --accept-license "${GITHUB_WORKSPACE}/tizen-studio"
          rm ./tizen-installer
          chmod -R +x "${GITHUB_WORKSPACE}/tizen-studio/tools/ide/bin"

      - name: Create Tizen Certificate
        run: |
          mkdir -p tizen-studio-data/keystore/author tizen-studio-data/profile
          ./tizen-studio/tools/ide/bin/tizen certificate -a $CERT_NAME -p $CERT_PASSWORD \
            -c NL -s Community -ct World -o $CERT_NAME -n $CERT_NAME -e community@example.org \
            -f ${CERT_NAME}
          ./tizen-studio/tools/ide/bin/tizen security-profiles add -n $CERT_NAME \
            -a ./tizen-studio-data/keystore/author/${CERT_NAME}.p12 -p $CERT_PASSWORD
          ./tizen-studio/tools/ide/bin/tizen cli-config "profiles.path=./tizen-studio-data/profile/profiles.xml"

      - name: Create expect script for signing
        id: package_exp
        run: |
          cat > ${GITHUB_WORKSPACE}/package.exp << 'EXPEOF'
          #!/usr/bin/expect -f
          set timeout 300
          set build_dir [lindex $argv 0]
          spawn $env(GITHUB_WORKSPACE)/tizen-studio/tools/ide/bin/tizen package -t wgt -s CommunityPack -- $build_dir
          expect {
              "Author password:" { send "$env(CERT_PASSWORD)\r"; exp_continue }
              "Save author password" { send "n\r"; exp_continue }
              "Distributor1 password:" { send "$env(CERT_PASSWORD)\r"; exp_continue }
              "Save distributor1 password" { send "n\r"; exp_continue }
              eof
          }
          EXPEOF
          chmod +x ${GITHUB_WORKSPACE}/package.exp
          echo "path=${GITHUB_WORKSPACE}/package.exp" >> $GITHUB_OUTPUT

      - name: Set Tizen path output
        id: set_tizen_path
        run: echo "path=${GITHUB_WORKSPACE}/tizen-studio" >> $GITHUB_OUTPUT

# --- Repo jobs: each uploads artifact ---
  release-repos:
    needs: prepare
    runs-on: ubuntu-latest
    env:
      TIZEN_PATH: ${{ needs.prepare.outputs.tizen_path }}
      PACKAGE_EXP: ${{ needs.prepare.outputs.signing_script }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup cache
        run: |
          mkdir -p wgt_files cache
          if [ ! -f cache/last_seen.json ]; then echo "{}" > cache/last_seen.json; fi

      - name: Check release-based repositories
        run: |
          declare -A repos=(
            ["OneLiberty/moonlight-chrome-tizen"]="release"
            ["MrPhaze62/moonlight-chrome-tizen-no-gamemode"]="release"
            ["PatrickSt1991/Sportlink.Club.Info.Viewer"]="release"
            ["reisxd/TizenBrew"]="release"
          )
          last_seen=$(cat cache/last_seen.json)
          updated=false
          for repo in "${!repos[@]}"; do
            owner=$(echo $repo | cut -d/ -f1)
            repo_name=$(echo $repo | cut -d/ -f2)
            api="https://api.github.com/repos/$repo/releases/latest"
            latest_tag=$(curl -s $api | jq -r '.tag_name // empty')
            [ -z "$latest_tag" ] && continue
            prev_tag=$(echo "$last_seen" | jq -r --arg r "$repo" '.[$r].tag // empty')
            if [ "$latest_tag" != "$prev_tag" ]; then
              echo "ðŸŽ‰ New release for $repo: $latest_tag"
              assets=$(curl -s $api | jq -r '.assets[]?.browser_download_url // empty')
              for url in $assets; do
                if [[ "$url" == *.wgt ]]; then
                  target_file="wgt_files/${owner}-${repo_name}.wgt"
                  wget -q -O "$target_file" "$url"
                fi
              done
              last_seen=$(echo "$last_seen" | jq --arg r "$repo" --arg t "$latest_tag" '.[$r].tag=$t')
              updated=true
            fi
          done
          echo "$last_seen" > cache/last_seen.json
          echo "UPDATED=$updated" >> $GITHUB_ENV

      - name: Upload release WGTs
        uses: actions/upload-artifact@v4
        with:
          name: release-wgts
          path: wgt_files/*.wgt

# --- Commit-based repos ---
  fireplace:
    needs: prepare
    runs-on: ubuntu-latest
    env:
      TIZEN_PATH: ${{ needs.prepare.outputs.tizen_path }}
      PACKAGE_EXP: ${{ needs.prepare.outputs.signing_script }}
    steps:
      - name: Build fireplace
        run: |
          git clone --depth 1 https://github.com/thonythony/fireplace.git
          cd fireplace
          npm install --no-audit
          npm run build -- --mode=production --no-watch || true
          $TIZEN_PATH/tools/ide/bin/tizen build-web || true
          $PACKAGE_EXP .
          mkdir -p ../wgt_files
          for f in $(find . -type f -name '*.wgt'); do
            cp "$f" "../wgt_files/thonythony-fireplace.wgt"
          done
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: fireplace-wgt
          path: wgt_files/*.wgt

  tvapp:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Download TVapp WGT
        run: |
          mkdir -p wgt_files
          wget -q -O wgt_files/KaashDev-TVapp.wgt "https://github.com/KaashDev/TVapp/raw/main/TVapp.wgt"
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: tvapp-wgt
          path: wgt_files/*.wgt

  vlc-tizen:
    needs: prepare
    runs-on: ubuntu-latest
    env:
      TIZEN_PATH: ${{ needs.prepare.outputs.tizen_path }}
      PACKAGE_EXP: ${{ needs.prepare.outputs.signing_script }}
    steps:
      - name: Build vlc-tizen
        run: |
          git clone --depth 1 https://github.com/dmaidaniuk/vlc-tizen.git
          cd vlc-tizen
          [ -f package.json ] && (npm install --no-audit && npm run build || npm run package || true)
          $TIZEN_PATH/tools/ide/bin/tizen build-web || true
          $PACKAGE_EXP .
          mkdir -p ../wgt_files
          for f in $(find . -type f -name '*.wgt'); do
            cp "$f" "../wgt_files/dmaidaniuk-vlc-tizen.wgt"
          done
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: vlc-tizen-wgt
          path: wgt_files/*.wgt

  smarttv-twitch:
    needs: prepare
    runs-on: ubuntu-latest
    env:
      TIZEN_PATH: ${{ needs.prepare.outputs.tizen_path }}
      PACKAGE_EXP: ${{ needs.prepare.outputs.signing_script }}
    steps:
      - name: Build smarttv-twitch
        run: |
          git clone --depth 1 https://github.com/fgl27/smarttv-twitch.git
          cd smarttv-twitch
          [ -f package.json ] && (npm install --no-audit && npm run build || npm run package || true)
          $TIZEN_PATH/tools/ide/bin/tizen build-web || true
          $PACKAGE_EXP .
          mkdir -p ../wgt_files
          for f in $(find . -type f -name '*.wgt'); do
            cp "$f" "../wgt_files/fgl27-smarttv-twitch.wgt"
          done
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: smarttv-twitch-wgt
          path: wgt_files/*.wgt

# --- Collect all artifacts and create release ---
  create-release:
    needs: [release-repos, fireplace, tvapp, vlc-tizen, smarttv-twitch]
    runs-on: ubuntu-latest
    steps:
      - name: Download all WGT artifacts
        uses: actions/download-artifact@v4
        with:
          path: merged_wgt
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: community-${{ github.run_number }}-$(date +%Y%m%d-%H%M%S)
          name: Community Package $(date +%Y-%m-%d)
          files: merged_wgt/**/*.wgt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}