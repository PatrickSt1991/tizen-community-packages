name: Sync Tizen Community Packages

on:
  workflow_dispatch:

permissions:
  contents: write

env:
  TIZEN_STUDIO_VER: 4
  CERT_NAME: CommunityPack
  CERT_PASSWORD: 1234
  NODE_OPTIONS: --openssl-legacy-provider

jobs:

  prepare:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Restore Tizen SDK cache
        id: tizen-sdk-cache
        uses: actions/cache@v4
        with:
          path: tizen-studio
          key: tizen-web-sdk-4.0

      - name: Install base dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget zip git jq nodejs npm expect curl unzip

      - name: Install Tizen Studio Web CLI
        if: steps.tizen-sdk-cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p tizen-studio
          curl -L -o tizen-installer \
            "https://github.com/PatrickSt1991/tizen-community-packages/releases/download/tizen-deps-5.5/web-cli_Tizen_Studio_4.0_ubuntu-64.bin"
          chmod +x tizen-installer
          ./tizen-installer --accept-license "$GITHUB_WORKSPACE/tizen-studio"
          rm tizen-installer
          chmod -R +x tizen-studio

      - name: Save SDK to cache
        if: steps.tizen-sdk-cache.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: tizen-studio
          key: tizen-web-sdk-4.0

      - name: Create signing certificate
        run: |
          mkdir -p tizen-studio-data/keystore/author tizen-studio-data/profile
          ./tizen-studio/tools/ide/bin/tizen certificate \
            -a "$CERT_NAME" -p "$CERT_PASSWORD" \
            -c NL -s Community -ct World \
            -o "$CERT_NAME" -n "$CERT_NAME" \
            -e community@example.org -f "$CERT_NAME"

          ./tizen-studio/tools/ide/bin/tizen security-profiles add \
            -n "$CERT_NAME" \
            -a "./tizen-studio-data/keystore/author/${CERT_NAME}.p12" \
            -p "$CERT_PASSWORD"

          ./tizen-studio/tools/ide/bin/tizen cli-config \
            "profiles.path=./tizen-studio-data/profile/profiles.xml"

      - name: Create expect script
        run: |
          printf '%s\n' \
            '#!/usr/bin/expect -f' \
            'set timeout 300' \
            'set build_dir [lindex $argv 0]' \
            'spawn $env(TIZEN_PATH)/tools/ide/bin/tizen package -t wgt -s CommunityPack -- $build_dir' \
            'expect {' \
            '  "Author password:" { send "$env(CERT_PASSWORD)\r"; exp_continue }' \
            '  "Distributor1 password:" { send "$env(CERT_PASSWORD)\r"; exp_continue }' \
            '  eof' \
            '}' \
            > package.exp
          chmod +x package.exp

      - uses: actions/upload-artifact@v4
        with:
          name: tizen-studio-artifact
          path: tizen-studio/

      - uses: actions/upload-artifact@v4
        with:
          name: package-exp-artifact
          path: package.exp


  generate-matrix-build:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}

    steps:
      - uses: actions/checkout@v4

      - id: set-matrix
        run: |
          matrix=$(jq -c \
            '{include: [to_entries[] | {
               repo: .key,
               repo_id: (.key | gsub("/"; "-")),
               branch: .value.branch,
               project_path: (.value.project_path // "."),
               output_name: (.value.output_name // "")
            }]}' repos-build.json)
          echo "matrix=$matrix" >> "$GITHUB_OUTPUT"


  tizen-build:
    runs-on: ubuntu-latest
    needs: [prepare, generate-matrix-build]

    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.generate-matrix-build.outputs.matrix).include }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: tizen-studio-artifact
          path: tizen-studio

      - uses: actions/download-artifact@v4
        with:
          name: package-exp-artifact
          path: .

      - name: Fix Tizen Studio permissions
        run: chmod -R +x tizen-studio

      - name: Install expect
        run: |
          sudo apt-get update
          sudo apt-get install -y expect

      - name: Build Tizen Web Project
        shell: bash
        env:
          TIZEN_PATH: ${{ github.workspace }}/tizen-studio
        run: |
          set -e
          mkdir -p build wgt_files
          cd build

          git clone --depth 1 --branch "${{ matrix.branch }}" "https://github.com/${{ matrix.repo }}.git"
          cd "$(basename "${{ matrix.repo }}")"

          cd "${{ matrix.project_path }}"

          echo "Building in: $(pwd)"
          "$TIZEN_PATH/tools/ide/bin/tizen" build-web

          echo "Packaging..."
          expect "$GITHUB_WORKSPACE/package.exp" "$(pwd)"

          actual=$(ls *.wgt | head -n 1)
          desired="${{ matrix.output_name }}"

          if [ -z "$desired" ] || [ "$desired" = "null" ]; then
            desired="$actual"
          fi

          cp "$actual" "$GITHUB_WORKSPACE/wgt_files/$desired"

      - uses: actions/upload-artifact@v4
        with:
          name: built-wgts-${{ matrix.repo_id }}
          path: wgt_files/


  external-downloads:
    runs-on: ubuntu-latest
    needs: tizen-build

    steps:
      - uses: actions/checkout@v4

      - name: Install jq & curl
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl git

      - name: Prepare folder
        run: mkdir -p external_wgts

      - name: Locate repos-sync.json
        id: config
        run: |
          if [ -f "repos-sync.json" ]; then
            echo "config=repos-sync.json" >> "$GITHUB_OUTPUT"
          elif [ -f ".github/workflows/repos-sync.json" ]; then
            echo "config=.github/workflows/repos-sync.json" >> "$GITHUB_OUTPUT"
          else
            echo "config=" >> "$GITHUB_OUTPUT"
          fi

      - name: Download release WGTs
        if: ${{ steps.config.outputs.config != '' }}
        run: |
          CFG="${{ steps.config.outputs.config }}"
          repos=$(jq -r '.releases | to_entries[] | .key' "$CFG")

          for repo in $repos; do
            branch=$(jq -r ".releases[\"$repo\"].branch" "$CFG")
            outname=$(jq -r ".releases[\"$repo\"].output_name" "$CFG")

            api="https://api.github.com/repos/$repo/releases/latest"
            json=$(curl -s "$api")

            url=$(echo "$json" | jq -r '.assets[].browser_download_url // empty' | head -n 1)

            if [ -z "$outname" ] || [ "$outname" = "null" ]; then
              outname="$(basename "$url")"
            fi

            curl -L -o "external_wgts/$outname" "$url"
          done

      - name: Download direct WGT URLs
        if: ${{ steps.config.outputs.config != '' }}
        run: |
          CFG="${{ steps.config.outputs.config }}"
          jq -r '.direct | to_entries[] | "\(.key) \(.value.url // .value) \(.value.output_name // "")"' "$CFG" |
          while read repo url outname; do
            [ -n "$repo" ] || continue

            if [ -z "$outname" ] || [ "$outname" = "null" ]; then
              outname="${repo##*/}.wgt"
            fi

            curl -L -o "external_wgts/$outname" "$url"
          done

      - uses: actions/upload-artifact@v4
        with:
          name: external-wgts
          path: external_wgts/


  publish-release:
    runs-on: ubuntu-latest
    needs: [tizen-build, external-downloads]

    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: built-wgts-*
          path: built

      - uses: actions/download-artifact@v4
        with:
          name: external-wgts
          path: external

      - name: Merge all wgt files
        run: |
          mkdir -p final_wgts
          cp built/**/*.wgt final_wgts/ 2>/dev/null || true
          cp external/*.wgt final_wgts/ 2>/dev/null || true
          echo "Final WGT files:"
          ls -l final_wgts

      - uses: softprops/action-gh-release@v2
        with:
          tag_name: "community-${{ github.run_number }}"
          name: "Community Packages ${{ github.run_number }}"
          files: "final_wgts/*.wgt"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
