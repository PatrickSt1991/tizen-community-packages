tizen-build:
    runs-on: ubuntu-latest
    needs:
      - prepare
      - generate-matrix-build

    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.generate-matrix-build.outputs.matrix).include }}

    steps:
      - uses: actions/checkout@v4

      # ---------------------------------------------------
      # Restore Tizen Studio + signing script from prepare job
      # ---------------------------------------------------
      - name: Download Tizen Studio artifact
        uses: actions/download-artifact@v4
        with:
          name: tizen-studio-artifact
          path: tizen-studio

      - name: Download expect script
        uses: actions/download-artifact@v4
        with:
          name: package-exp-artifact
          path: .

      # ---------------------------------------------------
      # Dependencies required by VLC extras/tools
      # ---------------------------------------------------
      - name: Install VLC prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            help2man ragel nasm meson protobuf-compiler \
            build-essential pkg-config automake autoconf libtool \
            gettext

      # ---------------------------------------------------
      # Clone & Build
      # ---------------------------------------------------
      - name: Clone and build project
        shell: bash
        env:
          TIZEN_SDK: ${{ github.workspace }}/tizen-studio
          TIZEN_PATH: ${{ github.workspace }}/tizen-studio
        run: |
          set -e

          mkdir -p "$GITHUB_WORKSPACE/wgt_files" build
          cd build

          git clone --depth 1 --branch "${{ matrix.branch }}" "https://github.com/${{ matrix.repo }}.git"
          cd "$(basename "${{ matrix.repo }}")"

          repo_name="$(basename "${{ matrix.repo }}")"
          echo "üî® Building repository: $repo_name"

          ###################################################
          #                 VLC-TIZEN SPECIAL
          ###################################################
          if [[ "$repo_name" == "vlc-tizen" ]]; then
            echo "‚öôÔ∏è Using local Tizen Studio SDK..."

            SYSROOT="$TIZEN_SDK/platforms/tizen-4.0/mobile/rootstraps/mobile-4.0-device.core"
            echo "üîß Using sysroot: $SYSROOT"

            # Proper sdk.version (some scripts source this file!)
            if [[ ! -f "$TIZEN_SDK/sdk.version" ]]; then
              printf '#!/bin/sh\necho 4.0\n' > "$TIZEN_SDK/sdk.version"
              chmod +x "$TIZEN_SDK/sdk.version"
              echo "üìÑ Created sdk.version script"
            fi

            echo "üîß Preparing environment..."

            # Ensure Tizen cross compiler is in PATH for buildall.sh ONLY
            export PATH="$TIZEN_SDK/tools/arm-linux-gnueabi-gcc-4.9/bin:$PATH"

            #############################################################
            # FIX 1: Build VLC extras/tools using HOST system GCC
            # BUT force compatibility with old VLC toolchain (C++03)
            #############################################################
            echo "üîß Prebuilding VLC tools (native GCC, C++03)..."
            
            # -------------------------------------------------------
            # 1) Clone VLC if missing
            # -------------------------------------------------------
            if [[ ! -d vlc ]]; then
              git clone https://code.videolan.org/videolan/vlc.git vlc
              pushd vlc
              git checkout 4e0fa1b
              popd
            fi
            
            # -------------------------------------------------------
            # 2) Ensure toolchain permissions
            # -------------------------------------------------------
            echo "üîß Making toolchain executable..."
            chmod -R +x "$TIZEN_SDK/tools/arm-linux-gnueabi-gcc-4.9/bin"
            chmod -R +x "$TIZEN_SDK/tools/arm-linux-gnueabi-gcc-4.9/libexec"
            
            # -------------------------------------------------------
            # 3) Build extras/tools with HOST GCC
            # -------------------------------------------------------
            pushd vlc/extras/tools
            export CC=gcc
            export CXX=g++
            export CFLAGS="-std=gnu11"
            export CXXFLAGS="-std=gnu++03 -Wno-deprecated-declarations"
            export LDFLAGS=""
            export CPPFLAGS=""
            
            echo "üîß Bootstrapping extras/tools..."
            ./bootstrap
            
            # If bootstrap regenerated contrib files, patch AFTER this
            popd
            
            echo "üîß Applying VLC contrib patches (FFmpeg + freetype)‚Ä¶"
            
            RULES="vlc/contrib/src/ffmpeg/rules.mak"
            FREETYPE_RULES="vlc/contrib/src/freetype2/rules.mak"
            
            FFMPEG_URL="https://ffmpeg.org/releases/ffmpeg-4.4.tar.xz"
            FREETYPE_URL="https://download.savannah.gnu.org/releases/freetype/freetype-2.6.1.tar.gz"
            
            # Ensure contrib directories exist
            mkdir -p vlc/contrib/tarballs/
            
            # -------------------------------------------------------
            # üî• FIX FAILED FFMPEG GIT CLONE
            # -------------------------------------------------------
            
            # This is the new, working command for the Makefile rule.
            # Note: It must be indented with a TAB for the Makefile.
            NEW_FFMPEG_COMMAND="\tTEMP_DIR=../../contrib/tarballs/ffmpeg-HEAD; rm -Rf \$\$TEMP_DIR; mkdir -p \$\$TEMP_DIR; curl -L \"$FFMPEG_URL\" | tar xJ --strip-components=1 -C \$\$TEMP_DIR; (cd ../../contrib/tarballs/ && tar cvJ ffmpeg-HEAD) > ../../contrib/tarballs/ffmpeg-HEAD.tar.xz; rm -Rf \$\$TEMP_DIR"
            
            # Use sed to find the line containing the broken 'git clone' 
            # command and replace it entirely with our new curl-based command.
            # <--- THIS IS THE MODIFIED LINE
            sed -i "/rm -Rf \.\.\/\.\.\/contrib\/tarballs\/ffmpeg-HEAD && git clone/c\\${NEW_FFMPEG_COMMAND}" "$RULES"
            
            # üî• FIX DEAD FREETYPE MIRROR
            sed -i '
                s#http://.*freetype.*2\.6\.1.*#'"$FREETYPE_URL"'#g
            ' "$FREETYPE_RULES"
            
            echo "üîß FFmpeg + freetype patches applied successfully."

            # -------------------------------------------------------
            # 5) Now build tools (full compile after patch)
            # -------------------------------------------------------
            pushd vlc/extras/tools
            
            # -------------------------------------------------------
            # üî• FIX: Patch dead GNU FTP links for autotools
            # -------------------------------------------------------
            echo "üîß Applying patches for dead GNU FTP links..."
            TOOLS_MAK="tools.mak"
            sed -i 's#http://ftp.gnu.org/gnu#https://ftpmirror.gnu.org#g' "$TOOLS_MAK"
            echo "üîß Patches applied to $TOOLS_MAK."
            # -------------------------------------------------------

            make -j"$(nproc)"
            popd
            #############################################################
            # FIX 2: Now run *VLC real build* which uses Tizen cross GCC
            #############################################################
            echo "üî® Building VLC (tizen)..."

            export TARGET_CC="$TIZEN_SDK/tools/arm-linux-gnueabi-gcc-4.9/bin/arm-linux-gnueabi-gcc --sysroot=$SYSROOT"
            export TARGET_CXX="$TIZEN_SDK/tools/arm-linux-gnueabi-gcc-4.9/bin/arm-linux-gnueabi-g++ --sysroot=$SYSROOT"

            ./buildall.sh -a armv7l

            echo "üì¶ Packaging VLC WGT..."
            expect "$GITHUB_WORKSPACE/package.exp" "$(pwd)" || true

            cp -r ./*.wgt "$GITHUB_WELCOM_WORKSPACE/wgt_files/" 2>/dev/null || true

          ###################################################
          #               ALL OTHER WEB PROJECTS
          ###################################################
          else
            echo "üåê Standard web build for $repo_name..."

            "$TIZEN_PATH/tools/ide/bin/tizen" build-web || true
            "$TIZEN_PATH/tools/ide/bin/tizen" package -t wgt -o "$GITHUB_WORKSPACE/wgt_files/" || true
          fi

      # ---------------------------------------------------
      # Upload WGTS from this repo build
      # ---------------------------------------------------
      - name: Upload WGTS to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "community-${{ github.run_number }}"
          name: "Community Packages ${{ github.run_number }}"
          files: "wgt_files/*.wgt"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}