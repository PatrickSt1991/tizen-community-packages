# This workflow syncs Tizen community packages.
# It includes a fix for building VLC host-tools by using a compiler shim.

name: Sync Tizen Community Packages

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

permissions:
  contents: write

env:
  TIZEN_STUDIO_VER: 4
  CERT_NAME: CommunityPack
  CERT_PASSWORD: 1234
  NODE_OPTIONS: --openssl-legacy-provider
  # TIZEN_PATH is now defined in the 'prepare' job and output
  # PACKAGE_EXP is also set in the 'prepare' job

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      tizen_path: ${{ steps.set_tizen_path.outputs.path }}
      package_exp: ${{ steps.set_package_exp.outputs.path }}

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget zip git jq nodejs npm expect curl unzip build-essential

      - name: Download and install Tizen Studio 4.0
        run: |
          mkdir -p tizen-studio
          curl -L -o tizen-installer "https://github.com/PatrickSt1991/tizen-community-packages/releases/download/tizen-deps-5.5/web-cli_Tizen_Studio_4.0_ubuntu-64.bin"
          chmod +x tizen-installer
          ./tizen-installer --accept-license "${GITHUB_WORKSPACE}/tizen-studio"
          rm ./tizen-installer
          chmod -R +x tizen-studio/tools/ide/bin

      - name: Create signing certificate
        run: |
          mkdir -p tizen-studio-data/keystore/author tizen-studio-data/profile
          ./tizen-studio/tools/ide/bin/tizen certificate -a "$CERT_NAME" -p "$CERT_PASSWORD" \
            -c NL -s Community -ct World -o "$CERT_NAME" -n "$CERT_NAME" -e community@example.org -f "$CERT_NAME"
          ./tizen-studio/tools/ide/bin/tizen security-profiles add -n "$CERT_NAME" \
            -a "./tizen-studio-data/keystore/author/${CERT_NAME}.p12" -p "$CERT_PASSWORD"
          ./tizen-studio/tools/ide/bin/tizen cli-config "profiles.path=./tizen-studio-data/profile/profiles.xml"

      - name: Create expect script for signing
        run: |
          echo '#!/usr/bin/expect -f' > package.exp
          echo 'set timeout 300' >> package.exp
          echo 'set build_dir [lindex $argv 0]' >> package.exp
          echo 'spawn $env(TIZEN_PATH)/tools/ide/bin/tizen package -t wgt -s CommunityPack -- $build_dir' >> package.exp
          echo 'expect {' >> package.exp
          echo '  "Author password:" { send "$env(CERT_PASSWORD)\r"; exp_continue }' >> package.exp
          echo '  "Distributor1 password:" { send "$env(CERT_PASSWORD)\r"; exp_continue }' >> package.exp
          echo '  eof' >> package.exp
          echo '}' >> package.exp
          chmod +x package.exp

      - name: Set Tizen output path
        id: set_tizen_path
        run: echo "path=${GITHUB_WORKSPACE}/tizen-studio" >> "$GITHUB_OUTPUT"

      - name: Set expect script output path
        id: set_package_exp
        run: echo "path=${GITHUB_WORKSPACE}/package.exp" >> "$GITHUB_OUTPUT"

  generate-matrix-build:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
      - id: set-matrix
        run: |
          matrix=$(jq -c '{include: [to_entries[] | {
            repo: .key,
            branch: .value.branch,
            build_script: (.value.build_script // ""),
            build_args: (.value.build_args // "")
          }]}' repos-build.json)
          echo "matrix=$matrix" >> "$GITHUB_OUTPUT"

  tizen-build:
    runs-on: ubuntu-latest
    needs: [prepare, generate-matrix-build]
    strategy:
      matrix: ${{ fromJson(needs.generate-matrix-build.outputs.matrix) }}
    env:
      TIZEN_PATH: ${{ needs.prepare.outputs.tizen_path }}
      PACKAGE_EXP: ${{ needs.prepare.outputs.package_exp }}
    steps:
      - uses: actions/checkout@v4

      - name: Clone and build project
        run: |
          set -e
          mkdir -p "$GITHUB_WORKSPACE/wgt_files" build
          cd build
          git clone --depth 1 --branch "${{ matrix.branch }}" "https://github.com/${{ matrix.repo }}.git"
          cd "$(basename "${{ matrix.repo }}")"

          repo_name="$(basename "${{ matrix.repo }}")"
          echo "‚úÖ Building repository: $repo_name"

          # --- vlc-tizen build ---
          if [[ "$repo_name" == "vlc-tizen" ]]; then
            echo "‚öôÔ∏è Advanced VLC-Tizen setup (host-tools fix + Tizen 4.0 SDK layout)..."

            # --- Create Tizen SDK layout (as buildall.sh expects this path) ---
            sudo mkdir -p /home/runner/tizen-sdk
            sudo ln -sfn "$TIZEN_PATH" /home/runner/tizen-sdk
            sudo mkdir -p /home/runner/tizen-sdk/platforms/tizen-4.0/mobile/rootstraps

            sudo mkdir -p /home/runner/tizen-sdk
            sudo bash -c "echo 'TIZEN_SDK_MAJOR=4' > /home/runner/tizen-sdk/sdk.version"
            sudo bash -c "echo 'TIZEN_SDK_MINOR=0' >> /home/runner/tizen-sdk/sdk.version"

            if [ ! -e /home/runner/tizen-sdk/platforms/tizen-4.0/mobile/rootstraps/mobile-4.0-device.core ]; then
              sudo ln -s "$TIZEN_PATH/platforms/tizen-4.0/mobile/rootstraps/mobile-4.0-device.core" \
                /home/runner/tizen-sdk/platforms/tizen-4.0/mobile/rootstraps/mobile-4.0-device.core
            fi

            # --- Sysroot env vars for pkg-config (used by buildall.sh) ---
            export SYSROOT="$TIZEN_PATH/platforms/tizen-4.0/mobile/rootstraps/mobile-4.0-device.core/usr"
            export CPPFLAGS="--sysroot=$SYSROOT -I$SYSROOT/include"
            export LDFLAGS="--sysroot=$SYSROOT -L$SYSROOT/lib"
            export PKG_CONFIG_PATH="$SYSROOT/lib/pkgconfig:$SYSROOT/usr/lib/pkgconfig"
            echo "‚úÖ Using sysroot: $SYSROOT"

            # --- SHIM: Intercept cross-compiler calls to build host tools ---
            echo "üß© Installing host-toolchain shims by replacing compilers..."
            TOOLCHAIN_BIN_DIR="$TIZEN_PATH/tools/arm-linux-gnueabi-gcc-4.9/bin"
            
            if [ -f "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-gcc" ]; then
              echo "Moving real cross-compilers..."
              mv "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-gcc" "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-gcc-real"
              mv "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-g++" "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-g++-real"
            else
              echo "‚ùå Real cross-compilers not found at $TOOLCHAIN_BIN_DIR"
              exit 1
            fi

            # --- GCC shim ---
            echo "Creating GCC shim..."
            echo '#!/usr/bin/env bash' | tee "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-gcc" >/dev/null
            echo '# Check for --sysroot flag. If not present, build for host.' >> "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-gcc"
            echo 'args=()' >> "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-gcc"
            echo 'has_sysroot=0' >> "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-gcc"
            echo 'for a in "$@"; do case "$a" in --sysroot=*) has_sysroot=1 ;; esac; args+=("$a"); done' >> "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-gcc"
            
            echo 'if [ $has_sysroot -eq 0 ]; then' >> "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-gcc"
            echo '  # echo "SHIM: Building for HOST with native gcc"' >> "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-gcc"
            echo '  host_args=()' >> "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-gcc"
            echo '  for a in "$@"; do' >> "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-gcc"
            echo '    case "$a" in' >> "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-gcc"
            echo '      --sysroot=*) ;;' >> "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-gcc"
            echo '      -march=*) ;;' >> "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-gcc"
            echo '      -mtune=*) ;;' >> "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-gcc"
            echo '      -mfpu=*) ;;' >> "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-gcc"
            echo '      -mthumb) ;;' >> "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-gcc"
            echo '      -mfloat-abi=*) ;;' >> "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-gcc"
            echo '      *) host_args+=("$a") ;;' >> "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-gcc"
            echo '    esac' >> "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-gcc"
            echo '  done' >> "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-gcc"
            echo '  exec gcc "${host_args[@]}"' >> "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-gcc"
            echo 'else' >> "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-gcc"
            echo '  # echo "SHIM: Cross-compiling with real gcc"' >> "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-gcc"
            echo '  exec '"$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-gcc-real"' "${args[@]}"' >> "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-gcc"
            echo 'fi' >> "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-gcc"

            # --- G++ shim ---
            echo "Creating G++ shim..."
            echo '#!/usr/bin/env bash' | tee "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-g++" >/dev/null
            echo 'args=()' >> "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-g++"
            echo 'has_sysroot=0' >> "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-g++"
            echo 'for a in "$@"; do case "$a" in --sysroot=*) has_sysroot=1 ;; esac; args+=("$a"); done' >> "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-g++"
            
            echo 'if [ $has_sysroot -eq 0 ]; then' >> "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-g++"
            echo '  # echo "SHIM: Building for HOST with native g++"' >> "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-g++"
            echo '  host_args=()' >> "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-g++"
            echo '  for a in "$@"; do' >> "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-g++"
            echo '    case "$a" in' >> "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-g++"
            echo '      --sysroot=*) ;;' >> "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-g++"
            echo '      -march=*) ;;' >> "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-g++"
            echo '      -mtune=*) ;;' >> "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-g++"
            echo '      -mfpu=*) ;;' >> "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-g++"
            echo '      -mthumb) ;;' >> "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-g++"
            echo '      -mfloat-abi=*) ;;' >> "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-g++"
            echo '      *) host_args+=("$a") ;;' >> "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-g++"
            echo '    esac' >> "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-g++"
            echo '  done' >> "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-g++"
            echo '  exec g++ "${host_args[@]}"' >> "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-g++"
            echo 'else' >> "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-g++"
            echo '  # echo "SHIM: Cross-compiling with real g++"' >> "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-g++"
            echo '  exec '"$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-g++-real"' "${args[@]}"' >> "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-g++"
            echo 'fi' >> "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-g++"

            chmod +x "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-gcc" "$TOOLCHAIN_BIN_DIR/arm-linux-gnueabi-g++"
            
            # --- Run the repo‚Äôs build script exactly as requested ---
            build_script="${{ matrix.build_script }}"
            build_args="${{ matrix.build_args }}"
            if [ -n "$build_script" ] && [ -f "$build_script" ]; then
              chmod +x "$build_script"
              echo "üöß Running $build_script $build_args..."
              # The build script will now use our shims automatically
              "./$build_script" $build_args || (
                echo "‚ùå Build failed, dumping config.log..."
                find . -name config.log -exec echo '---- {} ----' \; -exec tail -n 120 {} \;
                exit 1
              )
            else
              echo "‚ùå VLC build script not found: $build_script"
              exit 1
            fi

            username=$(echo "${{ matrix.repo }}" | cut -d'/' -f1)
            appname=$(basename "${{ matrix.repo }}" | sed 's/-tizen//')
            output_name="${username}-${appname}.wgt"
            find . -name "*.wgt" -exec mv {} "$GITHUB_WORKSPACE/wgt_files/$output_name" \;

          else
            echo "üåê Standard web build for $repo_name..."
            "$TIZEN_PATH/tools/ide/bin/tizen" build-web || true
            "$PACKAGE_EXP" . || true
            username=$(echo "${{ matrix.repo }}" | cut -d'/' -f1)
            appname=$(basename "${{ matrix.repo }}" | sed 's/-tizen//')
            output_name="${username}-${appname}.wgt"
            find . -name "*.wgt" -exec mv {} "$GITHUB_WORKSPACE/wgt_files/$output_name" \;
          fi

      - name: Upload WGTS to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "community-${{ github.run_number }}"
          name: "Community Packages ${{ github.run_number }}"
          files: "wgt_files/*.wgt"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
