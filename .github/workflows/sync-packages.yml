name: Sync Tizen Community Packages

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

permissions:
  contents: write

env:
  TIZEN_STUDIO_VER: 4
  CERT_NAME: CommunityPack
  CERT_PASSWORD: 1234
  NODE_OPTIONS: --openssl-legacy-provider

jobs:
  prepare:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            wget zip git jq nodejs npm expect curl unzip build-essential \
            libtool help2man ragel nasm protobuf-compiler meson
          
      - name: Download and install Tizen Studio 4.0
        run: |
          mkdir -p tizen-studio
          curl -L -o tizen-installer "https://github.com/PatrickSt1991/tizen-community-packages/releases/download/tizen-deps-5.5/web-cli_Tizen_Studio_4.0_ubuntu-64.bin"
          chmod +x tizen-installer
          ./tizen-installer --accept-license "${GITHUB_WORKSPACE}/tizen-studio"
          rm ./tizen-installer
          chmod -R +x tizen-studio/tools/ide/bin

      - name: Install Tizen 4.0 Rootstrap and Toolchain
        run: |
          set -e
          echo "Downloading missing Tizen 4.0 components..."
          BASE_URL="https://download.tizen.org/sdk/tizenstudio/official/binary"
          WORKDIR="${GITHUB_WORKSPACE}/tizen-studio"

          echo "üì¶ Downloading Rootstrap..."
          ROOTSTRAP_ZIP="mobile-4.0-rs-device.core_0.0.47_ubuntu-64.zip"
          curl -L -o "${WORKDIR}/rootstrap.zip" "$BASE_URL/$ROOTSTRAP_ZIP"

          echo "üìÇ Extracting Rootstrap..."
          unzip -o "${WORKDIR}/rootstrap.zip" -d "${WORKDIR}/"

          echo "üìÅ Installing Rootstrap into Tizen Studio..."
          mkdir -p "${WORKDIR}/platforms/tizen-4.0/mobile/rootstraps"
          mv "${WORKDIR}/data/platforms/tizen-4.0/mobile/rootstraps/mobile-4.0-device.core" \
             "${WORKDIR}/platforms/tizen-4.0/mobile/rootstraps/mobile-4.0-device.core"

          rm -rf "${WORKDIR}/data"
          rm "${WORKDIR}/rootstrap.zip"

          echo "üì¶ Downloading Toolchain..."
          TOOLCHAIN_ZIP="cross-arm-gcc-4.9_1.1.0_ubuntu-64.zip"
          curl -L -o "${WORKDIR}/toolchain.zip" "$BASE_URL/$TOOLCHAIN_ZIP"

          unzip -o "${WORKDIR}/toolchain.zip" "data/tools/*" -d "${WORKDIR}/"
          mv "${WORKDIR}/data/tools/arm-linux-gnueabi-gcc-4.9" "${WORKDIR}/tools/"
          rm -rf "${WORKDIR}/data"
          rm "${WORKDIR}/toolchain.zip"

          echo "‚úÖ Rootstrap & Toolchain installed successfully."

      - name: Create signing certificate
        run: |
          mkdir -p tizen-studio-data/keystore/author tizen-studio-data/profile
          ./tizen-studio/tools/ide/bin/tizen certificate -a "$CERT_NAME" -p "$CERT_PASSWORD" \
            -c NL -s Community -ct World -o "$CERT_NAME" -n "$CERT_NAME" -e community@example.org -f "$CERT_NAME"
          ./tizen-studio/tools/ide/bin/tizen security-profiles add -n "$CERT_NAME" \
            -a "./tizen-studio-data/keystore/author/${CERT_NAME}.p12" -p "$CERT_PASSWORD"
          ./tizen-studio/tools/ide/bin/tizen cli-config "profiles.path=./tizen-studio-data/profile/profiles.xml"

      - name: Create expect script for signing
        run: |
          {
            echo '#!/usr/bin/expect -f'
            echo 'set timeout 300'
            echo 'set build_dir [lindex $argv 0]'
            echo 'spawn $env(TIZEN_PATH)/tools/ide/bin/tizen package -t wgt -s CommunityPack -- $build_dir'
            echo 'expect {'
            echo '  "Author password:" { send "$env(CERT_PASSWORD)\r"; exp_continue }'
            echo '  "Distributor1 password:" { send "$env(CERT_PASSWORD)\r"; exp_continue }'
            echo '  eof'
            echo '}'
          } > package.exp
          chmod +x package.exp

      - name: Upload Tizen Studio artifact
        uses: actions/upload-artifact@v4
        with:
          name: tizen-studio-artifact
          path: tizen-studio/
          retention-days: 1

      - name: Upload expect script artifact
        uses: actions/upload-artifact@v4
        with:
          name: package-exp-artifact
          path: package.exp
          retention-days: 1

  generate-matrix-build:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
      - id: set-matrix
        run: |
          matrix=$(jq -c '{include: [to_entries[] | {
            repo: .key,
            branch: .value.branch,
            build_script: (.value.build_script // ""),
            build_args: (.value.build_args // "")
          }]}' repos-build.json)
          echo "matrix=$matrix" >> "$GITHUB_OUTPUT"

  tizen-build:
    runs-on: ubuntu-latest
    needs:
      - prepare
      - generate-matrix-build

    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.generate-matrix-build.outputs.matrix).include }}

    steps:
      - uses: actions/checkout@v4

      # ---------------------------------------------------
      # Restore Tizen Studio + signing script from prepare job
      # ---------------------------------------------------
      - name: Download Tizen Studio artifact
        uses: actions/download-artifact@v4
        with:
          name: tizen-studio-artifact
          path: tizen-studio

      - name: Download expect script
        uses: actions/download-artifact@v4
        with:
          name: package-exp-artifact
          path: .

      # ---------------------------------------------------
      # Dependencies required by VLC extras/tools
      # ---------------------------------------------------
      - name: Install VLC prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            help2man ragel nasm yasm meson protobuf-compiler \
            build-essential pkg-config automake autoconf libtool libtool-bin \
            gettext

      # ---------------------------------------------------
      # Clone & Build
      # ---------------------------------------------------
      - name: Clone and build project
        shell: bash
        env:
          TIZEN_SDK: ${{ github.workspace }}/tizen-studio
          TIZEN_PATH: ${{ github.workspace }}/tizen-studio
        run: |
          set -e

          mkdir -p "$GITHUB_WORKSPACE/wgt_files" build
          cd build

          git clone --depth 1 --branch "${{ matrix.branch }}" "https://github.com/${{ matrix.repo }}.git"
          cd "$(basename "${{ matrix.repo }}")"

          repo_name="$(basename "${{ matrix.repo }}")"
          echo "üî® Building repository: $repo_name"

          ###################################################
          #                 VLC-TIZEN SPECIAL
          ###################################################
          if [[ "$repo_name" == "vlc-tizen" ]]; then
            echo "‚öôÔ∏è Using local Tizen Studio SDK..."

            SYSROOT="$TIZEN_SDK/platforms/tizen-4.0/mobile/rootstraps/mobile-4.0-device.core"
            echo "üîß Using sysroot: $SYSROOT"

            # Proper sdk.version (some scripts source this file!)
            if [[ ! -f "$TIZEN_SDK/sdk.version" ]]; then
              printf '#!/bin/sh\necho 4.0\n' > "$TIZEN_SDK/sdk.version"
              chmod +x "$TIZEN_SDK/sdk.version"
              echo "üìÑ Created sdk.version script"
            fi

            echo "üîß Preparing environment..."
            export PATH="$TIZEN_SDK/tools/arm-linux-gnueabi-gcc-4.9/bin:$PATH"

            #############################################################
            # Step 1 ‚Äî Clone VLC source used by VLC-Tizen
            #############################################################
            echo "üîß Cloning upstream VLC core..."
            if [[ ! -d vlc ]]; then
              git clone https://code.videolan.org/videolan/vlc.git vlc
              pushd vlc
              git checkout 4e0fa1b
              popd
            fi

            #############################################################
            # Step 2 ‚Äî DEBUG + hard‚Äëpatch the ffmpeg-HEAD fetch rule
            # (rules live in vlc/contrib, not extras/tools)
            #############################################################
            echo "üîß DEBUG/PATCH: contrib ffmpeg rule"
            
            # Locate the actual rules file used by buildall.sh
            FFMPEG_RULES=$(ls vlc/contrib/src/ffmpeg/rules.mak* 2>/dev/null | head -n1 || true)
            if [[ -z "$FFMPEG_RULES" ]]; then
              echo "‚ùå Could not find vlc/contrib/src/ffmpeg/rules.mak*"; exit 2
            fi
            echo "üìÑ Using: $FFMPEG_RULES"
            
            # Show the current ffmpeg-HEAD recipe before patch
            echo "---- BEFORE (ffmpeg-HEAD.tar.xz recipe) ----"
            awk '
              /ffmpeg-HEAD\.tar\.xz:/ {print ">> " NR ":" $0; show=1; next}
              show && /^\t/ {print ">> " NR ":" $0; next}
              show && !/^\t/ {show=0}
            ' "$FFMPEG_RULES" || true
            echo "-------------------------------------------"
            
            # Replace the entire recipe with a tarball download (no git.libav.org)
            FFMPEG_URL="https://ffmpeg.org/releases/ffmpeg-4.4.tar.xz"
            awk -v url="$FFMPEG_URL" '
              BEGIN{inrec=0}
              /ffmpeg-HEAD\.tar\.xz:/ {
                print $0
                print "\tset -e; TEMP_DIR=../../contrib/tarballs/ffmpeg-HEAD; rm -Rf $$TEMP_DIR; mkdir -p $$TEMP_DIR; curl -L \"" url "\" | tar xJ --strip-components=1 -C $$TEMP_DIR; (cd ../../contrib/tarballs && tar cvJ ffmpeg-HEAD) > ../../contrib/tarballs/ffmpeg-HEAD.tar.xz; rm -Rf $$TEMP_DIR"
                inrec=1; next
              }
              inrec && /^\t/ { next }           # drop old recipe lines
              inrec && !/^\t/ { inrec=0; print; next }
              { print }
            ' "$FFMPEG_RULES" > "$FFMPEG_RULES.new" && mv "$FFMPEG_RULES.new" "$FFMPEG_RULES"
            
            # Show the patched recipe
            echo "---- AFTER (ffmpeg-HEAD.tar.xz recipe) ----"
            awk '
              /ffmpeg-HEAD\.tar\.xz:/ {print ">> " NR ":" $0; show=1; next}
              show && /^\t/ {print ">> " NR ":" $0; next}
              show && !/^\t/ {show=0}
            ' "$FFMPEG_RULES" || true
            echo "------------------------------------------"
            
            # Failsafe: pre-seed the tarball so fetch never tries to clone
            mkdir -p vlc/contrib/tarballs
            rm -rf vlc/contrib/tarballs/ffmpeg-HEAD
            if [[ ! -f vlc/contrib/tarballs/ffmpeg-HEAD.tar.xz ]]; then
              echo "üì¶ Pre-seeding ffmpeg-HEAD.tar.xz (failsafe)‚Ä¶"
              TEMP_DIR="vlc/contrib/tarballs/ffmpeg-HEAD"
              mkdir -p "$TEMP_DIR"
              curl -L "$FFMPEG_URL" | tar xJ --strip-components=1 -C "$TEMP_DIR"
              (cd vlc/contrib/tarballs && tar cvJ ffmpeg-HEAD) > vlc/contrib/tarballs/ffmpeg-HEAD.tar.xz
              rm -rf "$TEMP_DIR"
            fi
            ls -lh vlc/contrib/tarballs/ffmpeg-HEAD.tar.xz || true
            
            # Extra debug: surface any remaining dead URLs
            echo "üîé Grepping for git.libav.org under vlc/contrib‚Ä¶"
            grep -Rns "git\.libav\.org" vlc/contrib || echo "‚úÖ No references to git.libav.org"

            #############################################################
            # Step 3 ‚Äî Build extras/tools with HOST compiler
            #############################################################
            echo "üîß Building VLC extras/tools (native)‚Ä¶"

            chmod -R +x "$TIZEN_SDK/tools/arm-linux-gnueabi-gcc-4.9/bin" || true
            chmod -R +x "$TIZEN_SDK/tools/arm-linux-gnueabi-gcc-4.9/libexec" || true

            pushd vlc/extras/tools
            export CC=gcc
            export CXX=g++
            export CFLAGS="-std=gnu11"
            export CXXFLAGS="-std=gnu++03 -Wno-deprecated-declarations"
            export LDFLAGS=""
            export CPPFLAGS=""

            ./bootstrap
            make -j"$(nproc)"
            popd

            #############################################################
            # Step 4 ‚Äî Build Tizen VLC using cross toolchain
            #############################################################
            echo "üî® Building VLC (tizen)‚Ä¶"

            export TARGET_CC="$TIZEN_SDK/tools/arm-linux-gnueabi-gcc-4.9/bin/arm-linux-gnueabi-gcc --sysroot=$SYSROOT"
            export TARGET_CXX="$TIZEN_SDK/tools/arm-linux-gnueabi-gcc-4.9/bin/arm-linux-gnueabi-g++ --sysroot=$SYSROOT"

            ./buildall.sh -a armv7l

            echo "üì¶ Packaging VLC WGT..."
            expect "$GITHUB_WORKSPACE/package.exp" "$(pwd)" || true
            cp -r ./*.wgt "$GITHUB_WORKSPACE/wgt_files/" 2>/dev/null || true

          ###################################################
          #               ALL OTHER WEB PROJECTS
          ###################################################
          else
            echo "üåê Standard web build for $repo_name..."

            "$TIZEN_PATH/tools/ide/bin/tizen" build-web || true
            "$TIZEN_PATH/tools/ide/bin/tizen" package -t wgt -o "$GITHUB_WORKSPACE/wgt_files/" || true
          fi
      
      # ---------------------------------------------------
      # Upload WGTS from this repo build
      # ---------------------------------------------------
      - name: Upload WGTS to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "community-${{ github.run_number }}"
          name: "Community Packages ${{ github.run_number }}"
          files: "wgt_files/*.wgt"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-release:
    runs-on: ubuntu-latest
    needs: tizen-build
    steps:
      - name: Download all WGT artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-wgts

      - name: List downloaded files
        run: ls -R release-wgts || echo "No WGT files found"

      - name: Create GitHub Release with all WGTS
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "community-${{ github.run_number }}"
          name: "Community Packages ${{ github.run_number }}"
          files: "release-wgts/**/*.wgt"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
