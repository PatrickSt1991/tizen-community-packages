name: Sync Tizen Community Packages

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write

env:
  TIZEN_STUDIO_VER: 4
  CERT_NAME: CommunityPack
  CERT_PASSWORD: 1234
  NODE_OPTIONS: --openssl-legacy-provider
  TIZEN_PATH: ${{ github.workspace }}/tizen-studio
  PACKAGE_EXP: ${{ github.workspace }}/package.exp

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      tizen_path: ${{ steps.set_tizen_path.outputs.path }}
      signing_script: ${{ steps.package_exp.outputs.path }}
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget zip git jq nodejs npm expect curl unzip

      - name: Download and Install Tizen Studio 4.0 (from your release)
        run: |
          mkdir -p tizen-studio
          curl -L -o tizen-installer \
            "https://github.com/PatrickSt1991/tizen-community-packages/releases/download/tizen-deps-5.5/web-cli_Tizen_Studio_4.0_ubuntu-64.bin"
          chmod +x tizen-installer
          ./tizen-installer --accept-license "${GITHUB_WORKSPACE}/tizen-studio"
          rm ./tizen-installer
          chmod -R +x tizen-studio/tools/ide/bin || true

      - name: Install base SDK components
        run: |
          CLI="$GITHUB_WORKSPACE/tizen-studio/package-manager/package-manager-cli.bin"
          chmod +x "$CLI"
          "$CLI" install --accept-license WebCLI NativeCLI || true
          find "$GITHUB_WORKSPACE/tizen-studio/platforms" -maxdepth 2 -type d || true

      - name: Create Tizen Certificate
        run: |
          mkdir -p tizen-studio-data/keystore/author tizen-studio-data/profile
          ./tizen-studio/tools/ide/bin/tizen certificate -a "$CERT_NAME" -p "$CERT_PASSWORD" \
            -c NL -s Community -ct World -o "$CERT_NAME" -n "$CERT_NAME" -e community@example.org -f "$CERT_NAME"
          ./tizen-studio/tools/ide/bin/tizen security-profiles add -n "$CERT_NAME" \
            -a "./tizen-studio-data/keystore/author/${CERT_NAME}.p12" -p "$CERT_PASSWORD"
          ./tizen-studio/tools/ide/bin/tizen cli-config "profiles.path=./tizen-studio-data/profile/profiles.xml"

      - name: Create expect script for signing
        id: package_exp
        run: |
          echo '#!/usr/bin/expect -f' > "${GITHUB_WORKSPACE}/package.exp"
          echo 'set timeout 300' >> "${GITHUB_WORKSPACE}/package.exp"
          echo 'set build_dir [lindex $argv 0]' >> "${GITHUB_WORKSPACE}/package.exp"
          echo 'spawn $env(GITHUB_WORKSPACE)/tizen-studio/tools/ide/bin/tizen package -t wgt -s CommunityPack -- $build_dir' >> "${GITHUB_WORKSPACE}/package.exp"
          echo 'expect {' >> "${GITHUB_WORKSPACE}/package.exp"
          echo '  "Author password:" { send "$env(CERT_PASSWORD)\r"; exp_continue }' >> "${GITHUB_WORKSPACE}/package.exp"
          echo '  "Save author password" { send "n\r"; exp_continue }' >> "${GITHUB_WORKSPACE}/package.exp"
          echo '  "Distributor1 password:" { send "$env(CERT_PASSWORD)\r"; exp_continue }' >> "${GITHUB_WORKSPACE}/package.exp"
          echo '  "Save distributor1 password" { send "n\r"; exp_continue }' >> "${GITHUB_WORKSPACE}/package.exp"
          echo '  eof' >> "${GITHUB_WORKSPACE}/package.exp"
          echo '}' >> "${GITHUB_WORKSPACE}/package.exp"
          chmod +x "${GITHUB_WORKSPACE}/package.exp"
          echo "path=${GITHUB_WORKSPACE}/package.exp" >> "$GITHUB_OUTPUT"

      - name: Set Tizen path output
        id: set_tizen_path
        run: echo "path=${GITHUB_WORKSPACE}/tizen-studio" >> "$GITHUB_OUTPUT"

  tizen-build:
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - uses: actions/checkout@v4

      - name: Install VLC build prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential autoconf automake autopoint bison flex \
            gettext pkg-config help2man nasm yasm cmake ninja-build \
            python3 python3-pip python3-setuptools python3-wheel \
            libtool libprotobuf-dev protobuf-compiler \
            zlib1g-dev libssl-dev libxml2-dev libxslt1-dev \
            libasound2-dev libpulse-dev libc6-dev

      - name: Clone and build VLC-Tizen
        run: |
          mkdir -p "$GITHUB_WORKSPACE/wgt_files" build
          cd build
          git clone --depth 1 --branch master https://github.com/TizenTeam/vlc-tizen.git
          cd vlc-tizen

          echo "‚úÖ Checking GCC setup..."
          gcc --version || exit 1

          echo "üìÅ Creating Tizen SDK compatibility symlink..."
          sudo mkdir -p /home/runner
          sudo mkdir -p /home/runner/tizen-sdk
          sudo ln -sf "$TIZEN_PATH" /home/runner/tizen-sdk
          echo 'TIZEN_SDK_MAJOR=4' | sudo tee /home/runner/tizen-sdk/sdk.version >/dev/null
          echo 'TIZEN_SDK_MINOR=0' | sudo tee -a /home/runner/tizen-sdk/sdk.version >/dev/null

          sudo mkdir -p /home/runner/tizen-sdk/platforms/tizen-4.0/mobile/rootstraps
          sudo ln -sf "$TIZEN_PATH/platforms/tizen-4.0/mobile/rootstraps/mobile-4.0-device.core" \
            /home/runner/tizen-sdk/platforms/tizen-4.0/mobile/rootstraps/mobile-4.0-device.core

          echo "‚úÖ Creating run_with_tmpdir helper..."
          {
            echo '#!/bin/bash'
            echo 'export TMPDIR=/tmp'
            echo 'export TEMPDIR=/tmp'
            echo 'export CONFIG_SHELL=/bin/bash'
            echo 'exec "$@"'
          } | sudo tee /usr/local/bin/run_with_tmpdir >/dev/null
          sudo chmod +x /usr/local/bin/run_with_tmpdir

          echo "üõ†  Prebuilding VLC extras/tools..."
          git clone https://code.videolan.org/videolan/vlc.git vlc
          cd vlc
          git fetch --depth 1 origin 4e0fa1b || true
          git checkout 4e0fa1b || true
          make -C extras/tools -j2 CC=gcc CXX=g++ || true
          touch extras/tools/.pkg-config extras/tools/.automake extras/tools/.autoconf \
                extras/tools/.libtool extras/tools/.protobuf extras/tools/.meson extras/tools/.ragel || true
          cd ..

          echo "ü©π Patching buildall.sh..."
          sed -i 's|/home/runner/tizen-sdk|'"$TIZEN_PATH"'|g' buildall.sh || true
          sed -i 's|--sysroot=[^ ]*||g' buildall.sh || true

          echo "üöß Running buildall.sh..."
          /usr/local/bin/run_with_tmpdir ./buildall.sh -a armv7l || (
            echo "‚ùå Build failed, dumping config.log..."
            find . -name config.log -exec echo '---- {} ----' \; -exec tail -n 80 {} \;
            exit 1
          )

          find . -name "*.wgt" -exec mv {} "$GITHUB_WORKSPACE/wgt_files/" \;

      - name: Upload WGTS to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "community-${{ github.run_number }}"
          name: "Community Packages ${{ github.run_number }}"
          files: "wgt_files/*.wgt"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
