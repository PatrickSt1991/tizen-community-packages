name: Sync Tizen Community Packages

on:
  schedule:
    - cron: '0 0 * * *'  # every 24 hours
  workflow_dispatch:
    inputs: {} # Ensures the "Run workflow" button appears

permissions:
  contents: write

env:
  TIZEN_STUDIO_VER: 5.5
  CERT_NAME: CommunityPack
  CERT_PASSWORD: 1234

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Install dependencies
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget zip git jq nodejs npm expect curl

      # 3. Setup directories and cache
      - name: Setup directories
        run: |
          mkdir -p wgt_files
          mkdir -p cache
          if [ ! -f cache/last_seen.json ]; then
            echo "{}" > cache/last_seen.json
          fi

      - name: Load last seen state
        id: load_state
        run: |
          echo "LAST_SEEN=$(cat cache/last_seen.json)" >> $GITHUB_ENV

      # --- Part A: Release-based repositories ---
      - name: Check release-based repositories
        run: |
          declare -A repos=(
            ["OneLiberty/moonlight-chrome-tizen"]="release"
            ["MrPhaze62/moonlight-chrome-tizen-no-gamemode"]="release"
            ["PatrickSt1991/Sportlink.Club.Info.Viewer"]="release"
            ["reisxd/TizenBrew"]="release"
          )
          last_seen=$(cat cache/last_seen.json)
          updated=false

          for repo in "${!repos[@]}"; do
            api="https://api.github.com/repos/$repo/releases/latest"
            latest_tag=$(curl -s $api | jq -r '.tag_name // empty')
            [ -z "$latest_tag" ] && continue
            prev_tag=$(echo "$last_seen" | jq -r --arg r "$repo" '.[$r].tag // empty')

            if [ "$latest_tag" != "$prev_tag" ]; then
              echo "ðŸŽ‰ New release for $repo: $latest_tag"
              assets=$(curl -s $api | jq -r '.assets[]?.browser_download_url // empty')
              for url in $assets; do
                if [[ "$url" == *.wgt ]]; then
                  echo "Downloading WGT: $url"
                  wget -q -P wgt_files "$url"
                fi
              done
              last_seen=$(echo "$last_seen" | jq --arg r "$repo" --arg t "$latest_tag" '.[$r].tag=$t')
              updated=true
            fi
          done

          echo "$last_seen" > cache/last_seen.json
          echo "UPDATED=$updated" >> $GITHUB_ENV

      # --- Part B: Download Tizen Studio CLI (.bin installer) ---
      - name: Download Tizen Studio Installer
        run: |
          # Fixed typo: used TIZEN_STUDIO_VER instead of TIZEN_STUDEN_VER
          curl -o tizen-installer "https://download.tizen.org/sdk/Installer/tizen-studio_${TIZEN_STUDIO_VER}/web-cli_Tizen_Studio_${TIZEN_STUDIO_VER}_ubuntu-64.bin"
          chmod +x tizen-installer
          ./tizen-installer --accept-license "${GITHUB_WORKSPACE}/tizen-studio"
          rm ./tizen-installer

      # --- Part C: Create certificate ---
      - name: Create Tizen Certificate
        run: |
          mkdir -p tizen-studio-data/keystore/author
          ./tizen-studio/tools/ide/bin/tizen certificate -a $CERT_NAME -p $CERT_PASSWORD \
            -c NL -s Community -ct World -o $CERT_NAME -n $CERT_NAME -e community@example.org \
            -f ${CERT_NAME} ./tizen-studio-data/keystore/author/${CERT_NAME}.p12
          ./tizen-studio/tools/ide/bin/tizen security-profiles add -n $CERT_NAME \
            -a ./tizen-studio-data/keystore/author/${CERT_NAME}.p12 -p $CERT_PASSWORD
          ./tizen-studio/tools/ide/bin/tizen cli-config "profiles.path=./tizen-studio-data/profile/profiles.xml"

      # --- Part D: Commit-based repositories with automatic WGT signing ---
      - name: Check commit-based repositories and build WGT
        run: |
          declare -A repos=(
            ["thonythony/fireplace"]="fireplace"
            ["KaashDev/TVapp"]="TVapp"
            ["dmaidaniuk/vlc-tizen"]="vlc-tizen"
            ["fgl27/smarttv-twitch"]="smarttv-twitch"
          )

          last_seen=$(cat cache/last_seen.json)
          updated=${UPDATED:-false}

          for repo in "${!repos[@]}"; do
            api="https://api.github.com/repos/$repo/commits?per_page=1"
            latest_sha=$(curl -s $api | jq -r '.[0].sha // empty')
            [ -z "$latest_sha" ] && continue
            prev_sha=$(echo "$last_seen" | jq -r --arg r "$repo" '.[$r].sha // empty')

            if [ "$latest_sha" != "$prev_sha" ]; then
              echo "ðŸ”§ New commit for $repo"
              git clone --depth 1 "https://github.com/$repo.git"
              cd "$(basename $repo)"

              # Build or download WGT
              case "$repo" in
                "fgl27/smarttv-twitch"|"dmaidaniuk/vlc-tizen"|"thonythony/fireplace")
                  npm install --no-audit
                  # Run build/package steps from the user's "runnable" version
                  npm run build || npm run package || true
                  
                  # Execute the mandatory Tizen web build step
                  ../tizen-studio/tools/ide/bin/tizen build-web
                  
                  # Create expect script for automated signing (fixes password issue)
                  # We use 'EOF' (quoted) to prevent shell expansion of $env(GITHUB_WORKSPACE)
                  # The expect script itself will correctly read $env(CERT_PASSWORD)
                  cat > package.exp << 'EOF'
#!/usr/bin/expect -f
set timeout 300
spawn $env(GITHUB_WORKSPACE)/tizen-studio/tools/ide/bin/tizen package -t wgt -s CommunityPack -- .
expect {
    "Author password:" {
        send "$env(CERT_PASSWORD)\r"
        exp_continue
    }
    "Save author password" {
        send "n\r"
        exp_continue
    }
    "Distributor1 password:" {
        send "$env(CERT_PASSWORD)\r"
        exp_continue
    }
    "Save distributor1 password" {
        send "n\r"
        exp_continue
    }
    eof
}
EOF
                  chmod +x package.exp
                  ./package.exp
                  ;;
                "KaashDev/TVapp")
                  # This repo downloads a pre-built WGT, so no build/signing is needed
                  wget -q -O ../wgt_files/TVapp.wgt "https://github.com/KaashDev/TVapp/raw/main/TVapp.wgt"
                  cd ..
                  last_seen=$(echo "$last_seen" | jq --arg r "$repo" --arg s "$latest_sha" '.[$r].sha=$s')
                  updated=true
                  continue
                  ;;
              esac

              # Move WGT files to central folder for repos that were built/signed
              mkdir -p ../wgt_files
              find . -type f -name '*.wgt' -exec cp {} ../wgt_files/ \;

              cd ..
              last_seen=$(echo "$last_seen" | jq --arg r "$repo" --arg s "$latest_sha" '.[$r].sha=$s')
              updated=true
            fi
          done

          echo "$last_seen" > cache/last_seen.json
          echo "UPDATED=$updated" >> $GITHUB_ENV

      # --- Part E: Commit cache changes ---
      - name: Commit cache
        if: env.UPDATED == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add cache/last_seen.json
          git commit -m "Update last-seen cache [skip ci]" || true
          git push

      # --- Part F: Create community release ---
      - name: Create GitHub Release
        if: env.UPDATED == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "community-$(date +%Y%m%d)"
          name: "Community Package $(date +%Y-%m-%d)"
          files: "wgt_files/*"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
