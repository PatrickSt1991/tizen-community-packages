name: Sync Tizen Community Packages

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs: {}

permissions:
  contents: write

env:
  TIZEN_STUDIO_VER: 5.5
  CERT_NAME: CommunityPack
  CERT_PASSWORD: 1234
  NODE_OPTIONS: --openssl-legacy-provider

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      tizen_path: ${{ steps.set_tizen_path.outputs.path }}
      signing_script: ${{ steps.package_exp.outputs.path }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget zip git jq nodejs npm expect curl openjdk-11-jdk

      - name: Install Tizen Studio CLI
        run: |
          mkdir -p tizen-studio
          curl -L -o tizen-cli.bin "https://download.tizen.org/sdk/Installer/tizen-studio_${TIZEN_STUDIO_VER}/web-cli_Tizen_Studio_${TIZEN_STUDIO_VER}_ubuntu-64.bin"
          chmod +x tizen-cli.bin
          yes | ./tizen-cli.bin --accept-license --no-progress tizen-studio
          rm tizen-cli.bin
          chmod -R +x tizen-studio/tools/ide/bin

      - name: Create Tizen Certificate
        run: |
          mkdir -p tizen-studio-data/keystore/author tizen-studio-data/profile
          ./tizen-studio/tools/ide/bin/tizen certificate -a $CERT_NAME -p $CERT_PASSWORD \
            -c NL -s Community -ct World -o $CERT_NAME -n $CERT_NAME -e community@example.org \
            -f ${CERT_NAME}
          ./tizen-studio/tools/ide/bin/tizen security-profiles add -n $CERT_NAME \
            -a ./tizen-studio-data/keystore/author/${CERT_NAME}.p12 -p $CERT_PASSWORD
          ./tizen-studio/tools/ide/bin/tizen cli-config "profiles.path=./tizen-studio-data/profile/profiles.xml"

      - name: Create expect script for signing
        id: package_exp
        run: |
          cat > ${GITHUB_WORKSPACE}/package.exp << 'EXPEOF'
          #!/usr/bin/expect -f
          set timeout 300
          set build_dir [lindex $argv 0]
          spawn $env(GITHUB_WORKSPACE)/tizen-studio/tools/ide/bin/tizen package -t wgt -s CommunityPack -- $build_dir
          expect {
              "Author password:" { send "$env(CERT_PASSWORD)\r"; exp_continue }
              "Save author password" { send "n\r"; exp_continue }
              "Distributor1 password:" { send "$env(CERT_PASSWORD)\r"; exp_continue }
              "Save distributor1 password" { send "n\r"; exp_continue }
              eof
          }
          EXPEOF
          chmod +x ${GITHUB_WORKSPACE}/package.exp
          echo "path=${GITHUB_WORKSPACE}/package.exp" >> $GITHUB_OUTPUT

      - name: Set Tizen path output
        id: set_tizen_path
        run: echo "path=${GITHUB_WORKSPACE}/tizen-studio" >> $GITHUB_OUTPUT

  process-repo:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      matrix:
        repo: [
          "OneLiberty/moonlight-chrome-tizen",
          "MrPhaze62/moonlight-chrome-tizen-no-gamemode",
          "PatrickSt1991/Sportlink.Club.Info.Viewer",
          "reisxd/TizenBrew",
          "thonythony/fireplace",
          "KaashDev/TVapp",
          "dmaidaniuk/vlc-tizen",
          "fgl27/smarttv-twitch"
        ]
    env:
      TIZEN_PATH: ${{ needs.prepare.outputs.tizen_path }}
      PACKAGE_EXP: ${{ needs.prepare.outputs.signing_script }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup cache
        run: |
          mkdir -p wgt_files cache
          if [ ! -f cache/last_seen.json ]; then echo "{}" > cache/last_seen.json; fi

      - name: Load last seen state
        run: echo "LAST_SEEN=$(cat cache/last_seen.json)" >> $GITHUB_ENV

      - name: Process repo
        run: |
          owner=$(echo ${{ matrix.repo }} | cut -d/ -f1)
          reponame=$(echo ${{ matrix.repo }} | cut -d/ -f2)
          echo "Processing $owner/$reponame"

          # Release-based
          if [[ "${{ matrix.repo }}" == OneLiberty* || "${{ matrix.repo }}" == MrPhaze62* || "${{ matrix.repo }}" == PatrickSt1991* || "${{ matrix.repo }}" == reisxd* ]]; then
            api="https://api.github.com/repos/${{ matrix.repo }}/releases/latest"
            latest_tag=$(curl -s $api | jq -r '.tag_name // empty')
            prev_tag=$(jq -r --arg r "${{ matrix.repo }}" '.[$r].tag // empty' cache/last_seen.json)
            if [[ "$latest_tag" != "$prev_tag" && -n "$latest_tag" ]]; then
              echo "ðŸŽ‰ New release: $latest_tag"
              assets=$(curl -s $api | jq -r '.assets[]?.browser_download_url // empty')
              for url in $assets; do
                [[ "$url" == *.wgt ]] && wget -q -O "wgt_files/${owner}-${reponame}.wgt" "$url"
              done
              jq --arg r "${{ matrix.repo }}" --arg t "$latest_tag" '.[$r].tag=$t' cache/last_seen.json > tmp.json && mv tmp.json cache/last_seen.json
            fi
          else
            # Commit-based
            api="https://api.github.com/repos/${{ matrix.repo }}/commits?per_page=1"
            latest_sha=$(curl -s $api | jq -r '.[0].sha // empty')
            prev_sha=$(jq -r --arg r "${{ matrix.repo }}" '.[$r].sha // empty' cache/last_seen.json)
            if [[ "$latest_sha" != "$prev_sha" && -n "$latest_sha" ]]; then
              echo "ðŸ”§ New commit: $latest_sha"
              git clone --depth 1 "https://github.com/${{ matrix.repo }}.git"
              cd "$reponame"
              if [ -f package.json ]; then
                npm install --no-audit
                npm run build || npm run package || true
              fi
              $TIZEN_PATH/tools/ide/bin/tizen build-web || true
              $PACKAGE_EXP .
              mkdir -p ../wgt_files
              find . -type f -name '*.wgt' -exec cp {} "../wgt_files/${owner}-${reponame}.wgt" \;
              cd ..
              jq --arg r "${{ matrix.repo }}" --arg s "$latest_sha" '.[$r].sha=$s' cache/last_seen.json > tmp.json && mv tmp.json cache/last_seen.json
            fi
          fi

      - name: Commit updated cache
        if: always()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add cache/last_seen.json
          git commit -m "Update last-seen cache [skip ci]" || true
          git push

      - name: Create release (per repo)
        if: always()
        uses: softprops/action-gh-release@v2
        with:
          tag_name: community-${{ github.run_number }}-${{ matrix.repo }}
          name: Community Package - ${{ matrix.repo }}
          files: "wgt_files/${owner}-${reponame}.wgt"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}